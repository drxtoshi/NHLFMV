<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHL Periods | +EV Finder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0e14;
            --bg2: #12171f;
            --bg3: #1a2028;
            --bg4: #242c38;
            --accent: #3b82f6;
            --accent2: #60a5fa;
            --profit: #22c55e;
            --profit-bg: rgba(34,197,94,0.1);
            --loss: #ef4444;
            --loss-bg: rgba(239,68,68,0.1);
            --warn: #f59e0b;
            --txt: #f1f5f9;
            --txt2: #94a3b8;
            --txt3: #64748b;
            --bdr: rgba(255,255,255,0.08);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',system-ui,sans-serif; background:var(--bg); color:var(--txt); min-height:100vh; font-size:14px; }
        .app { max-width:1400px; margin:0 auto; padding:16px; }
        
        /* Header */
        .header { display:flex; justify-content:space-between; align-items:center; padding:12px 0 16px; border-bottom:1px solid var(--bdr); margin-bottom:16px; }
        .logo { display:flex; align-items:center; gap:10px; }
        .logo-icon { font-size:24px; }
        .logo h1 { font-size:18px; font-weight:600; }
        .controls { display:flex; gap:8px; align-items:center; }
        .status { display:flex; align-items:center; gap:6px; padding:6px 12px; background:var(--bg2); border-radius:6px; font-size:12px; color:var(--txt2); }
        .dot { width:6px; height:6px; border-radius:50%; background:var(--profit); }
        .dot.off { background:var(--loss); }
        .btn { padding:8px 14px; border:none; border-radius:6px; font-family:inherit; font-weight:500; font-size:13px; cursor:pointer; transition:all 0.15s; }
        .btn-primary { background:var(--accent); color:white; }
        .btn-primary:hover { background:var(--accent2); }
        .btn-secondary { background:var(--bg3); color:var(--txt2); border:1px solid var(--bdr); }
        .btn-secondary:hover { background:var(--bg4); color:var(--txt); }
        
        /* Config Panel */
        .config { background:var(--bg2); border:1px solid var(--bdr); border-radius:8px; padding:16px; margin-bottom:16px; display:none; }
        .config.show { display:block; }
        .config-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .config-title { font-size:14px; font-weight:600; }
        .config-grid { display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; }
        .field { display:flex; flex-direction:column; gap:6px; }
        .field label { font-size:11px; font-weight:500; color:var(--txt3); text-transform:uppercase; letter-spacing:0.5px; }
        .field input, .field select { padding:8px 10px; background:var(--bg); border:1px solid var(--bdr); border-radius:6px; color:var(--txt); font-family:inherit; font-size:13px; }
        .field input:focus, .field select:focus { outline:none; border-color:var(--accent); }
        
        /* Book Selector */
        .book-section { grid-column: span 2; }
        .book-selector { display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
        .book-tag { padding:4px 10px; background:var(--bg); border:1px solid var(--bdr); border-radius:4px; font-size:12px; cursor:pointer; transition:all 0.15s; user-select:none; }
        .book-tag:hover { border-color:var(--txt3); }
        .book-tag.selected { background:var(--accent); border-color:var(--accent); color:white; }
        .book-tag.selected.sharp { background:var(--profit); border-color:var(--profit); }
        
        /* Stats Bar */
        .stats { display:flex; gap:12px; margin-bottom:16px; }
        .stat { background:var(--bg2); border:1px solid var(--bdr); border-radius:8px; padding:12px 16px; flex:1; }
        .stat-label { font-size:11px; color:var(--txt3); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
        .stat-value { font-size:20px; font-weight:600; }
        .stat-value.green { color:var(--profit); }
        .stat-value.blue { color:var(--accent); }
        
        /* Games */
        .games { display:flex; flex-direction:column; gap:12px; }
        .game { background:var(--bg2); border:1px solid var(--bdr); border-radius:8px; overflow:hidden; }
        .game.has-edge { border-color:var(--profit); }
        
        /* Game Header */
        .game-header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:var(--bg3); }
        .matchup { display:flex; align-items:center; gap:20px; }
        .team { display:flex; align-items:center; gap:8px; }
        .team-abbr { font-size:11px; font-weight:600; color:var(--txt3); background:var(--bg); padding:4px 8px; border-radius:4px; }
        .team-name { font-weight:500; }
        .team-score { font-size:20px; font-weight:700; color:var(--accent); margin-left:8px; }
        .vs { color:var(--txt3); font-size:12px; }
        .game-info { text-align:right; }
        .game-status { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:4px; font-size:12px; font-weight:500; }
        .game-status.live { background:var(--profit-bg); color:var(--profit); }
        .game-status.upcoming { background:var(--bg); color:var(--txt3); }
        .game-time { font-size:18px; font-weight:600; color:var(--warn); margin-top:4px; }
        .game-date { font-size:12px; color:var(--txt3); margin-top:2px; }
        
        /* Period Tabs */
        .period-tabs { display:flex; gap:4px; padding:8px 16px; background:var(--bg); border-bottom:1px solid var(--bdr); }
        .period-tab { padding:6px 14px; background:transparent; border:1px solid transparent; border-radius:4px; color:var(--txt3); font-family:inherit; font-size:12px; font-weight:500; cursor:pointer; transition:all 0.15s; position:relative; }
        .period-tab:hover { color:var(--txt); background:var(--bg3); }
        .period-tab.active { background:var(--accent); color:white; }
        .period-tab.has-edge::after { content:''; position:absolute; top:2px; right:2px; width:6px; height:6px; background:var(--profit); border-radius:50%; }
        .period-tab:disabled { opacity:0.4; cursor:default; }
        
        /* Odds Section */
        .odds-section { padding:16px; }
        .odds-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .odds-title { font-size:13px; font-weight:600; color:var(--txt2); }
        .consensus-pills { display:flex; gap:16px; }
        .pill { text-align:center; }
        .pill-label { font-size:10px; color:var(--txt3); text-transform:uppercase; }
        .pill-value { font-size:14px; font-weight:600; color:var(--accent); }
        
        /* Odds Table */
        .odds-table { width:100%; border-collapse:collapse; }
        .odds-table th { padding:8px 12px; text-align:left; font-size:10px; font-weight:600; color:var(--txt3); text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid var(--bdr); }
        .odds-table td { padding:10px 12px; border-bottom:1px solid var(--bdr); font-size:13px; }
        .odds-table tr:last-child td { border-bottom:none; }
        .odds-table tr:hover { background:rgba(255,255,255,0.02); }
        .odds-table .consensus-row { background:var(--bg3); }
        .odds-table .consensus-row td { border-top:2px solid var(--accent); font-weight:500; }
        
        .book-cell { display:flex; align-items:center; gap:8px; }
        .book-logo { width:24px; height:24px; background:var(--bg4); border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:700; color:var(--txt3); }
        .book-name { font-weight:500; }
        .book-badge { font-size:9px; padding:2px 6px; border-radius:3px; font-weight:600; }
        .book-badge.sharp { background:var(--profit-bg); color:var(--profit); }
        .book-badge.soft { background:rgba(59,130,246,0.1); color:var(--accent); }
        
        .odds-cell { text-align:center; }
        .odds-value { display:inline-block; padding:4px 8px; border-radius:4px; font-weight:500; min-width:60px; }
        .odds-value.best { background:var(--profit-bg); color:var(--profit); }
        .odds-value.worst { background:var(--loss-bg); color:var(--loss); }
        
        .ev-cell { text-align:center; }
        .ev-value { display:inline-block; padding:4px 8px; border-radius:4px; font-weight:600; min-width:65px; }
        .ev-value.positive { background:var(--profit-bg); color:var(--profit); }
        .ev-value.negative { color:var(--txt3); }
        
        .signal-cell { }
        .edge-badge { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:var(--profit); color:var(--bg); border-radius:4px; font-size:11px; font-weight:600; }
        
        /* Alerts */
        .alerts { position:fixed; top:16px; right:16px; width:280px; max-height:40vh; overflow-y:auto; display:flex; flex-direction:column; gap:6px; z-index:1000; }
        .alert { padding:10px 12px; background:var(--bg2); border:1px solid var(--profit); border-radius:6px; cursor:pointer; transition:all 0.15s; }
        .alert:hover { transform:translateX(-2px); background:var(--bg3); }
        .alert-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .alert-title { font-size:12px; font-weight:600; color:var(--profit); }
        .alert-time { font-size:10px; color:var(--txt3); }
        .alert-body { font-size:12px; color:var(--txt2); }
        .alert-body strong { color:var(--txt); }
        .alert-ev { display:inline-block; margin-left:6px; padding:2px 6px; background:var(--profit-bg); color:var(--profit); border-radius:3px; font-weight:600; font-size:11px; }
        
        /* Empty/Loading States */
        .empty { text-align:center; padding:48px 20px; color:var(--txt3); }
        .empty-icon { font-size:40px; margin-bottom:12px; }
        .empty h3 { font-size:16px; color:var(--txt2); margin-bottom:6px; }
        .loading { text-align:center; padding:32px; }
        .spinner { width:32px; height:32px; border:3px solid var(--bdr); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 12px; }
        @keyframes spin { to { transform:rotate(360deg); } }
        
        /* Debug */
        .debug { background:var(--bg2); border:1px solid var(--bdr); border-radius:6px; padding:12px; margin-top:16px; font-size:11px; font-family:monospace; max-height:180px; overflow-y:auto; display:none; }
        .debug pre { white-space:pre-wrap; word-break:break-all; color:var(--txt3); }
        
        /* Table scroll wrapper */
        .table-scroll { overflow-x:auto; }
        
        /* Responsive */
        @media (max-width: 900px) {
            .config-grid { grid-template-columns:repeat(2, 1fr); }
            .book-section { grid-column: span 2; }
            .stats { flex-wrap:wrap; }
            .stat { min-width:calc(50% - 6px); }
        }
        
        /* Mobile Mode - Fully compact, no horizontal scroll */
        .mobile-mode .app { padding:6px; }
        .mobile-mode .header { padding:6px 0 10px; flex-direction:column; gap:8px; }
        .mobile-mode .logo { gap:6px; }
        .mobile-mode .logo-icon { font-size:18px; }
        .mobile-mode .logo h1 { font-size:14px; }
        .mobile-mode .controls { width:100%; justify-content:center; gap:4px; flex-wrap:wrap; }
        .mobile-mode .controls .btn { padding:5px 8px; font-size:11px; }
        .mobile-mode .status { padding:4px 6px; font-size:10px; gap:4px; }
        .mobile-mode .status .dot { width:5px; height:5px; }
        
        .mobile-mode .stats { gap:4px; margin-bottom:10px; }
        .mobile-mode .stat { padding:6px 8px; min-width:calc(25% - 3px); flex:1; border-radius:6px; }
        .mobile-mode .stat-label { font-size:8px; margin-bottom:2px; }
        .mobile-mode .stat-value { font-size:13px; }
        
        .mobile-mode .games { gap:6px; }
        .mobile-mode .game { border-radius:6px; }
        .mobile-mode .game-header { padding:8px 10px; }
        .mobile-mode .matchup { gap:6px; }
        .mobile-mode .team { gap:4px; }
        .mobile-mode .team-name { font-size:12px; }
        .mobile-mode .team-score { font-size:16px; margin-left:4px; }
        .mobile-mode .team-abbr { font-size:9px; padding:2px 4px; }
        .mobile-mode .vs { font-size:10px; }
        .mobile-mode .game-status { padding:3px 6px; font-size:10px; }
        .mobile-mode .game-date { font-size:10px; }
        
        .mobile-mode .period-tabs { padding:4px 8px; gap:2px; }
        .mobile-mode .period-tab { padding:4px 8px; font-size:10px; }
        
        .mobile-mode .odds-section { padding:8px; }
        .mobile-mode .odds-header { margin-bottom:8px; flex-direction:column; gap:6px; align-items:stretch; }
        .mobile-mode .odds-title { font-size:11px; }
        .mobile-mode .consensus-pills { gap:8px; justify-content:space-between; }
        .mobile-mode .pill-label { font-size:8px; }
        .mobile-mode .pill-value { font-size:11px; }
        
        /* Mobile table - ultra compact */
        .mobile-mode .table-scroll { overflow-x:visible; }
        .mobile-mode .odds-table { min-width:auto; width:100%; table-layout:fixed; }
        .mobile-mode .odds-table th { padding:4px 2px; font-size:8px; text-align:center; }
        .mobile-mode .odds-table th:first-child { text-align:left; width:50px; }
        .mobile-mode .odds-table td { padding:5px 2px; text-align:center; font-size:10px; }
        .mobile-mode .odds-table td:first-child { text-align:left; }
        
        .mobile-mode .book-cell { gap:0; justify-content:flex-start; }
        .mobile-mode .book-logo { width:28px; height:20px; font-size:7px; border-radius:3px; font-weight:700; }
        .mobile-mode .book-name { display:none; }
        .mobile-mode .book-badge { display:none; }
        
        .mobile-mode .odds-value { padding:2px 3px; min-width:auto; font-size:10px; border-radius:3px; }
        .mobile-mode .ev-value { padding:2px 3px; min-width:auto; font-size:10px; border-radius:3px; }
        .mobile-mode .edge-badge { padding:2px 4px; font-size:9px; border-radius:3px; }
        .mobile-mode .signal-cell { font-size:9px; }
        
        .mobile-mode .consensus-row td:first-child { font-size:9px; }
        .mobile-mode .consensus-row td:first-child span { font-size:9px !important; }
        
        /* Hide Line column on mobile */
        .mobile-mode .odds-table th:nth-child(2),
        .mobile-mode .odds-table td:nth-child(2) { display:none; }
        
        /* Config mobile */
        .mobile-mode .config { padding:10px; }
        .mobile-mode .config-grid { grid-template-columns:1fr 1fr; gap:8px; }
        .mobile-mode .config-title { font-size:12px; }
        .mobile-mode .field label { font-size:9px; }
        .mobile-mode .field input, .mobile-mode .field select { padding:6px 8px; font-size:11px; }
        .mobile-mode .book-section { grid-column: span 2; }
        .mobile-mode .book-selector { gap:3px; }
        .mobile-mode .book-tag { padding:3px 6px; font-size:10px; }
        
        /* Alerts mobile */
        .mobile-mode .alerts { width:200px; top:8px; right:8px; gap:4px; }
        .mobile-mode .alert { padding:6px 8px; border-radius:4px; }
        .mobile-mode .alert-title { font-size:10px; }
        .mobile-mode .alert-time { font-size:8px; }
        .mobile-mode .alert-body { font-size:10px; }
        .mobile-mode .alert-ev { font-size:9px; padding:1px 4px; margin-left:4px; }
        
        .mobile-mode #mobileToggle { background:var(--accent); color:white; }
        
        /* Debug mobile */
        .mobile-mode .debug { font-size:9px; padding:8px; max-height:120px; }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <div class="logo">
            <span class="logo-icon">üèí</span>
            <h1>NHL Periods</h1>
        </div>
        <div class="controls">
            <div class="status"><div class="dot off" id="dot"></div><span id="statusTxt">Disconnected</span></div>
            <button class="btn btn-secondary" id="mobileToggle" onclick="toggleMobile()">üì±</button>
            <button class="btn btn-secondary" onclick="toggleConfig()">Settings</button>
            <button class="btn btn-primary" onclick="fetchData()">Refresh</button>
            <button class="btn btn-secondary" onclick="loadDemo()">Demo</button>
        </div>
    </header>
    
    <div class="config" id="config">
        <div class="config-header">
            <span class="config-title">Settings</span>
        </div>
        <div class="config-grid">
            <div class="field">
                <label>API Key</label>
                <input type="password" id="apiKey" placeholder="SportsGameOdds API Key">
            </div>
            <div class="field">
                <label>Min EV %</label>
                <input type="number" id="minEV" value="2" min="0" max="20" step="0.5">
            </div>
            <div class="field">
                <label>Refresh (sec)</label>
                <input type="number" id="refreshInt" value="30" min="10">
            </div>
            <div class="field">
                <label>Sound Alerts</label>
                <select id="alertSound">
                    <option value="on">Enabled</option>
                    <option value="off">Disabled</option>
                </select>
            </div>
            <div class="field book-section">
                <label>Sharp Books (Fair Value Source)</label>
                <div class="book-selector" id="sharpSelector"></div>
            </div>
            <div class="field book-section">
                <label>Compare Books (Check for +EV)</label>
                <div class="book-selector" id="compareSelector"></div>
            </div>
        </div>
    </div>
    
    <div class="stats">
        <div class="stat"><div class="stat-label">Games</div><div class="stat-value blue" id="sGames">0</div></div>
        <div class="stat"><div class="stat-label">+EV Opps</div><div class="stat-value green" id="sEV">0</div></div>
        <div class="stat"><div class="stat-label">Best Edge</div><div class="stat-value green" id="sBest">--</div></div>
        <div class="stat"><div class="stat-label">Updated</div><div class="stat-value" id="sTime" style="font-size:14px">--</div></div>
    </div>
    
    <div class="games" id="games">
        <div class="loading"><div class="spinner"></div><div style="color:var(--txt3)">Enter API key and refresh, or click Demo</div></div>
    </div>
    
    <div class="debug" id="debug"><pre id="log"></pre></div>
</div>

<div class="alerts" id="alerts"></div>

<script>
const CFG = {
    apiKey: '',
    minEV: 2,
    refresh: 30,
    sound: true,
    sharpBooks: ['pinnacle', 'circa', 'bookmaker'],
    compareBooks: ['draftkings', 'fanduel', 'betmgm', 'caesars']
};

const BOOKS = {
    pinnacle: {n:'Pinnacle', a:'PIN', c:'#c41230'},
    circa: {n:'Circa', a:'CCA', c:'#d4af37'},
    bookmaker: {n:'Bookmaker', a:'BKM', c:'#1a4d1a'},
    betcris: {n:'BetCRIS', a:'CRS', c:'#003366'},
    betonline: {n:'BetOnline', a:'BOL', c:'#8b0000'},
    draftkings: {n:'DraftKings', a:'DK', c:'#53d337'},
    fanduel: {n:'FanDuel', a:'FD', c:'#1493ff'},
    betmgm: {n:'BetMGM', a:'MGM', c:'#c9a227'},
    caesars: {n:'Caesars', a:'CZR', c:'#0d4524'},
    pointsbet: {n:'PointsBet', a:'PB', c:'#e44c23'},
    betrivers: {n:'BetRivers', a:'BR', c:'#1275ba'},
    bet365: {n:'Bet365', a:'365', c:'#027b5b'},
    espnbet: {n:'ESPN Bet', a:'ESPN', c:'#d00'},
    fanatics: {n:'Fanatics', a:'FAN', c:'#004687'}
};

const SHARP_LIST = ['pinnacle','circa','bookmaker','betcris','betonline'];
const SOFT_LIST = ['draftkings','fanduel','betmgm','caesars','pointsbet','betrivers','bet365','espnbet','fanatics'];

let DATA = [], alerted = new Set(), timer = null, mobileMode = false;

function log(m) { document.getElementById('log').textContent += `${new Date().toLocaleTimeString()} ${m}\n`; console.log(m); }

function toggleMobile() {
    mobileMode = !mobileMode;
    document.body.classList.toggle('mobile-mode', mobileMode);
    localStorage.setItem('ppMobile', mobileMode ? '1' : '0');
}

document.addEventListener('DOMContentLoaded', () => {
    loadCfg();
    renderBookSelectors();
    const k = localStorage.getItem('sgKey');
    if (k) { document.getElementById('apiKey').value = k; CFG.apiKey = k; }
    // Load mobile state
    if (localStorage.getItem('ppMobile') === '1') {
        mobileMode = true;
        document.body.classList.add('mobile-mode');
    }
});

function loadCfg() {
    const s = localStorage.getItem('ppCfg2');
    if (s) {
        Object.assign(CFG, JSON.parse(s));
        document.getElementById('minEV').value = CFG.minEV;
        document.getElementById('refreshInt').value = CFG.refresh;
        document.getElementById('alertSound').value = CFG.sound ? 'on' : 'off';
    }
}

function saveCfg() {
    CFG.apiKey = document.getElementById('apiKey').value;
    CFG.minEV = parseFloat(document.getElementById('minEV').value);
    CFG.refresh = parseInt(document.getElementById('refreshInt').value);
    CFG.sound = document.getElementById('alertSound').value === 'on';
    localStorage.setItem('sgKey', CFG.apiKey);
    localStorage.setItem('ppCfg2', JSON.stringify(CFG));
}

function renderBookSelectors() {
    const sharpEl = document.getElementById('sharpSelector');
    const compareEl = document.getElementById('compareSelector');
    
    sharpEl.innerHTML = SHARP_LIST.map(k => 
        `<div class="book-tag ${CFG.sharpBooks.includes(k) ? 'selected sharp' : ''}" onclick="toggleSharp('${k}')">${BOOKS[k].n}</div>`
    ).join('');
    
    compareEl.innerHTML = [...SOFT_LIST, ...SHARP_LIST].map(k => 
        `<div class="book-tag ${CFG.compareBooks.includes(k) ? 'selected' : ''}" onclick="toggleCompare('${k}')">${BOOKS[k].n}</div>`
    ).join('');
}

function toggleSharp(k) {
    const i = CFG.sharpBooks.indexOf(k);
    if (i > -1) CFG.sharpBooks.splice(i, 1);
    else CFG.sharpBooks.push(k);
    renderBookSelectors();
    saveCfg();
    if (DATA.length) render();
}

function toggleCompare(k) {
    const i = CFG.compareBooks.indexOf(k);
    if (i > -1) CFG.compareBooks.splice(i, 1);
    else CFG.compareBooks.push(k);
    renderBookSelectors();
    saveCfg();
    if (DATA.length) render();
}

function toggleConfig() { document.getElementById('config').classList.toggle('show'); }
function setStatus(on, txt) { document.getElementById('dot').className = 'dot' + (on ? '' : ' off'); document.getElementById('statusTxt').textContent = txt; }

async function fetchData() {
    saveCfg();
    if (!CFG.apiKey) { alert('Enter API key in Settings'); toggleConfig(); return; }
    document.getElementById('debug').style.display = 'block';
    document.getElementById('log').textContent = '';
    setStatus(false, 'Loading...');
    document.getElementById('games').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        const oddIDs = ['points-all-1p-ou-over','points-all-1p-ou-under','points-all-2p-ou-over','points-all-2p-ou-under','points-all-3p-ou-over','points-all-3p-ou-under'].join(',');
        const url = `https://api.sportsgameodds.com/v2/events?apiKey=${CFG.apiKey}&leagueID=NHL&oddsAvailable=true&includeOpposingOdds=true&oddIDs=${oddIDs}`;
        log('Fetching...');
        
        const res = await fetch(url);
        if (!res.ok) throw new Error('API Error ' + res.status);
        
        const json = await res.json();
        const events = json.data || [];
        log(`Got ${events.length} events`);
        
        // Properly detect live games using status object
        const live = events.filter(e => {
            const st = e.status || {};
            return st.started === true && st.completed !== true && st.cancelled !== true;
        });
        log(`Live: ${live.length}`);
        
        // Show live games first, then upcoming
        const upcoming = events.filter(e => {
            const st = e.status || {};
            return !st.started && !st.completed && !st.cancelled;
        });
        
        const toShow = [...live, ...upcoming.slice(0, 10 - live.length)];
        DATA = toShow.map(e => ({ game: e, pOdds: extractOdds(e.odds || {}) }));
        
        log(`Showing ${DATA.length} games (${live.length} live, ${DATA.length - live.length} upcoming)`);
        
        render();
        updateStats();
        setStatus(true, live.length > 0 ? `${live.length} Live` : 'Connected');
        if (timer) clearInterval(timer);
        timer = setInterval(fetchData, CFG.refresh * 1000);
    } catch (err) {
        log('Error: ' + err.message);
        setStatus(false, 'Error');
        document.getElementById('games').innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><h3>Error</h3><p>${err.message}</p></div>`;
    }
}

function extractOdds(odds) {
    const r = {'1p':{line:1.5,books:[]}, '2p':{line:1.5,books:[]}, '3p':{line:1.5,books:[]}};
    for (const [id, o] of Object.entries(odds)) {
        const m = id.match(/(points|goals)-all-(1p|2p|3p)-ou-(over|under)/i);
        if (!m) continue;
        const period = m[2].toLowerCase();
        const side = m[3].toLowerCase();
        const line = parseFloat(o.bookOverUnder || o.fairOverUnder) || 1.5;
        r[period].line = line;
        if (o.byBookmaker) {
            for (const [bk, bd] of Object.entries(o.byBookmaker)) {
                if (!bd.available) continue;
                let be = r[period].books.find(x => x.bk === bk);
                if (!be) { be = {bk, line: parseFloat(bd.overUnder) || line}; r[period].books.push(be); }
                be[side + 'Price'] = parseInt(bd.odds);
            }
        }
    }
    return r;
}

// Math
const a2d = a => a >= 100 ? (a/100)+1 : (100/Math.abs(a))+1;
const a2p = a => a >= 100 ? 100/(a+100) : Math.abs(a)/(Math.abs(a)+100);
const noVig = (o,u) => { const op=a2p(o), up=a2p(u), t=op+up; return {o:op/t, u:up/t}; };
const p2a = p => p >= 0.5 ? Math.round(-100*p/(1-p)) : Math.round(100*(1-p)/p);
const calcEV = (odds, fp) => ((fp * a2d(odds)) - 1) * 100;

function consensus(books, line) {
    const sb = books.filter(b => CFG.sharpBooks.includes(b.bk?.toLowerCase()) && b.overPrice && b.underPrice);
    if (!sb.length) return null;
    let to=0, tu=0;
    sb.forEach(b => { const nv = noVig(b.overPrice, b.underPrice); to += nv.o; tu += nv.u; });
    return { oP: to/sb.length, uP: tu/sb.length, oFair: p2a(to/sb.length), uFair: p2a(tu/sb.length), line, cnt: sb.length };
}

function render() {
    const c = document.getElementById('games');
    if (!DATA.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üèí</div><h3>No Games</h3><p>Click Demo to preview</p></div>'; return; }
    c.innerHTML = DATA.map(({game: g, pOdds}) => {
        const edge = hasEdge(pOdds);
        return `<div class="game${edge ? ' has-edge' : ''}" id="g-${g.eventID}">${gameHeader(g)}${periodTabs(g, pOdds)}${oddsSection(g, pOdds)}</div>`;
    }).join('');
}

function gameHeader(g) {
    const t = g.teams || {};
    const aw = t.away || {}, hm = t.home || {};
    const awA = aw.names?.abbr || aw.teamID?.split('_')[0] || 'AWY';
    const hmA = hm.names?.abbr || hm.teamID?.split('_')[0] || 'HME';
    const awN = aw.names?.short || aw.names?.long || awA;
    const hmN = hm.names?.short || hm.names?.long || hmA;
    
    // Score from results or score object
    let awS = 0, hmS = 0;
    if (g.results) {
        const pts = Object.values(g.results).find(r => r.away !== undefined && r.home !== undefined);
        if (pts) { awS = pts.away || 0; hmS = pts.home || 0; }
    }
    if (g.score) {
        awS = g.score.away?.total ?? g.score.away ?? awS;
        hmS = g.score.home?.total ?? g.score.home ?? hmS;
    }
    
    // Status
    const st = g.status || {};
    const isLive = st.started && !st.completed;
    const period = st.currentPeriodID?.replace('p','') || st.period || '';
    const inBreak = st.inBreak;
    
    // Start time for upcoming
    let startInfo = '';
    if (!isLive && st.startsAt) {
        const d = new Date(st.startsAt);
        const today = new Date();
        const isToday = d.toDateString() === today.toDateString();
        const time = d.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
        startInfo = isToday ? time : `${d.toLocaleDateString([], {month: 'short', day: 'numeric'})} ${time}`;
    }
    
    return `<div class="game-header">
        <div class="matchup">
            <div class="team">
                <span class="team-abbr">${awA}</span>
                <span class="team-name">${awN}</span>
                ${isLive ? `<span class="team-score">${awS}</span>` : ''}
            </div>
            <span class="vs">@</span>
            <div class="team">
                ${isLive ? `<span class="team-score">${hmS}</span>` : ''}
                <span class="team-name">${hmN}</span>
                <span class="team-abbr">${hmA}</span>
            </div>
        </div>
        <div class="game-info">
            ${isLive ? `
                <div class="game-status live">
                    <div class="dot"></div>
                    ${inBreak ? 'INT' : 'P' + period}
                </div>
            ` : `
                <div class="game-status upcoming">Upcoming</div>
                ${startInfo ? `<div class="game-date">${startInfo}</div>` : ''}
            `}
        </div>
    </div>`;
}

function periodTabs(g, pOdds) {
    const st = g.status || {};
    const isLive = st.started && !st.completed;
    const cp = parseInt(st.currentPeriodID?.replace('p','') || st.period) || 1;
    
    return `<div class="period-tabs">${['1p','2p','3p'].map((p, i) => {
        const n = i + 1;
        const has = pOdds[p]?.books?.length > 0;
        const edge = has && pEdge(pOdds[p]);
        const isCurrent = isLive && n === cp;
        return `<button class="period-tab${isCurrent ? ' active' : ''}${edge ? ' has-edge' : ''}" 
            data-p="${p}" onclick="switchP(this,'${g.eventID}')" ${!has ? 'disabled' : ''}>
            P${n}${isCurrent ? ' (Live)' : ''}
        </button>`;
    }).join('')}</div>`;
}

function switchP(btn, gid) {
    btn.parentElement.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    const gd = DATA.find(d => d.game.eventID === gid);
    if (gd) {
        const sec = document.querySelector('#g-' + gid + ' .odds-section');
        if (sec) sec.outerHTML = oddsSection(gd.game, gd.pOdds, btn.dataset.p);
    }
}

function oddsSection(g, pOdds, selP = null) {
    const st = g.status || {};
    const isLive = st.started && !st.completed;
    const cp = selP || (isLive ? (st.currentPeriodID || '1p') : '1p');
    const pd = pOdds[cp] || {line: 1.5, books: []};
    const cons = consensus(pd.books, pd.line);
    
    return `<div class="odds-section">
        <div class="odds-header">
            <span class="odds-title">Period ${cp.replace('p','')} Total</span>
            ${cons ? `<div class="consensus-pills">
                <div class="pill"><div class="pill-label">Line</div><div class="pill-value">${cons.line}</div></div>
                <div class="pill"><div class="pill-label">Fair O</div><div class="pill-value">${fmt(cons.oFair)}</div></div>
                <div class="pill"><div class="pill-label">Fair U</div><div class="pill-value">${fmt(cons.uFair)}</div></div>
                <div class="pill"><div class="pill-label">Sharp#</div><div class="pill-value">${cons.cnt}</div></div>
            </div>` : ''}
        </div>
        ${oddsTable(pd, cons, g)}
    </div>`;
}

function oddsTable(pd, cons, g) {
    if (!pd.books.length) return '<div class="empty" style="padding:24px">No odds available</div>';
    
    const show = [...new Set([...CFG.sharpBooks, ...CFG.compareBooks])];
    const filtered = pd.books.filter(b => show.includes(b.bk?.toLowerCase()));
    if (!filtered.length) return '<div class="empty" style="padding:24px">No odds from selected books</div>';
    
    let bo=-Infinity, bu=-Infinity, wo=Infinity, wu=Infinity;
    filtered.forEach(b => {
        if (b.overPrice) { bo = Math.max(bo, b.overPrice); wo = Math.min(wo, b.overPrice); }
        if (b.underPrice) { bu = Math.max(bu, b.underPrice); wu = Math.min(wu, b.underPrice); }
    });
    
    const sorted = [...filtered].sort((a,b) => {
        const aS = CFG.sharpBooks.includes(a.bk?.toLowerCase()) ? 0 : 1;
        const bS = CFG.sharpBooks.includes(b.bk?.toLowerCase()) ? 0 : 1;
        return aS - bS;
    });
    
    return `<div class="table-scroll"><table class="odds-table">
        <thead><tr><th>Book</th><th>Line</th><th style="text-align:center">Over</th><th style="text-align:center">Under</th><th style="text-align:center">O EV</th><th style="text-align:center">U EV</th><th>Signal</th></tr></thead>
        <tbody>
            ${cons ? `<tr class="consensus-row">
                <td><span style="color:var(--accent);font-weight:600">‚ö° Sharp Consensus (${cons.cnt})</span></td>
                <td>${cons.line}</td>
                <td class="odds-cell"><span class="odds-value">${fmt(cons.oFair)}</span></td>
                <td class="odds-cell"><span class="odds-value">${fmt(cons.uFair)}</span></td>
                <td>--</td><td>--</td><td style="color:var(--accent)">Fair Value</td>
            </tr>` : ''}
            ${sorted.map(b => oddsRow(b, cons, bo, bu, wo, wu, g, filtered.length)).join('')}
        </tbody>
    </table></div>`;
}

function oddsRow(b, cons, bo, bu, wo, wu, g, tot) {
    const bk = (b.bk || '').toLowerCase();
    const bkd = BOOKS[bk] || {n: b.bk, a: bk.substring(0,3).toUpperCase(), c: '#666'};
    const isSharp = CFG.sharpBooks.includes(bk);
    const isCompare = CFG.compareBooks.includes(bk);
    
    let oEV = null, uEV = null;
    if (cons && isCompare) {
        if (b.overPrice) oEV = calcEV(b.overPrice, cons.oP);
        if (b.underPrice) uEV = calcEV(b.underPrice, cons.uP);
    }
    
    const oE = oEV && oEV >= CFG.minEV;
    const uE = uEV && uEV >= CFG.minEV;
    
    if (oE || uE) {
        const k = `${g.eventID}-${bk}-${b.line}-${b.overPrice}-${b.underPrice}`;
        if (!alerted.has(k)) { alerted.add(k); triggerAlert(g, bkd, b, oEV, uEV, oE, uE); }
    }
    
    return `<tr>
        <td><div class="book-cell">
            <div class="book-logo" style="background:${bkd.c};color:#fff">${bkd.a}</div>
            <span class="book-name">${bkd.n}</span>
        </div></td>
        <td>${b.line || 1.5}</td>
        <td class="odds-cell">${b.overPrice ? `<span class="odds-value${b.overPrice===bo?' best':''}${b.overPrice===wo&&tot>2?' worst':''}">${fmt(b.overPrice)}</span>` : '--'}</td>
        <td class="odds-cell">${b.underPrice ? `<span class="odds-value${b.underPrice===bu?' best':''}${b.underPrice===wu&&tot>2?' worst':''}">${fmt(b.underPrice)}</span>` : '--'}</td>
        <td class="ev-cell">${oEV !== null ? `<span class="ev-value${oEV >= CFG.minEV ? ' positive' : ' negative'}">${oEV > 0 ? '+' : ''}${oEV.toFixed(1)}%</span>` : '--'}</td>
        <td class="ev-cell">${uEV !== null ? `<span class="ev-value${uEV >= CFG.minEV ? ' positive' : ' negative'}">${uEV > 0 ? '+' : ''}${uEV.toFixed(1)}%</span>` : '--'}</td>
        <td class="signal-cell">${oE ? `<span class="edge-badge">O+${oEV.toFixed(0)}%</span>` : ''}${uE ? `<span class="edge-badge">U+${uEV.toFixed(0)}%</span>` : ''}</td>
    </tr>`;
}

const fmt = a => a == null ? '--' : (a > 0 ? '+' + a : String(a));
const hasEdge = po => ['1p','2p','3p'].some(p => pEdge(po[p]));
function pEdge(pd) {
    if (!pd?.books?.length) return false;
    const c = consensus(pd.books, pd.line);
    if (!c) return false;
    return pd.books.some(b => {
        if (!CFG.compareBooks.includes(b.bk?.toLowerCase())) return false;
        return (b.overPrice && calcEV(b.overPrice, c.oP) >= CFG.minEV) || (b.underPrice && calcEV(b.underPrice, c.uP) >= CFG.minEV);
    });
}

function triggerAlert(g, bkd, b, oEV, uEV, oE, uE) {
    const c = document.getElementById('alerts');
    const t = g.teams || {};
    const aw = t.away?.names?.abbr || 'AWY', hm = t.home?.names?.abbr || 'HME';
    const side = oE && (!uE || oEV > uEV) ? `O ${b.line}` : `U ${b.line}`;
    const ev = oE && (!uE || oEV > uEV) ? oEV : uEV;
    const pr = oE && (!uE || oEV > uEV) ? b.overPrice : b.underPrice;
    const id = 'a' + Date.now();
    c.insertAdjacentHTML('afterbegin', `<div class="alert" id="${id}" onclick="dismissAlert('${id}')">
        <div class="alert-header"><span class="alert-title">üî• ${aw} @ ${hm}</span><span class="alert-time">${new Date().toLocaleTimeString([],{hour:'numeric',minute:'2-digit'})}</span></div>
        <div class="alert-body">${bkd.n}: <strong>${side}</strong> ${fmt(pr)}<span class="alert-ev">+${ev.toFixed(1)}%</span></div>
    </div>`);
    if (CFG.sound) beep();
    setTimeout(() => dismissAlert(id), 120000);
}

function dismissAlert(id) { const a = document.getElementById(id); if (a) { a.style.opacity = '0'; setTimeout(() => a.remove(), 200); } }
function beep() { try { const x = new AudioContext(), o = x.createOscillator(), g = x.createGain(); o.connect(g); g.connect(x.destination); o.frequency.value = 800; g.gain.setValueAtTime(0.15, x.currentTime); g.gain.exponentialRampToValueAtTime(0.01, x.currentTime + 0.15); o.start(); o.stop(x.currentTime + 0.15); } catch(e){} }

function updateStats() {
    const liveCount = DATA.filter(d => d.game.status?.started && !d.game.status?.completed).length;
    document.getElementById('sGames').textContent = DATA.length + (liveCount ? ` (${liveCount} live)` : '');
    document.getElementById('sTime').textContent = new Date().toLocaleTimeString([],{hour:'numeric',minute:'2-digit'});
    let cnt = 0, best = 0;
    DATA.forEach(({pOdds}) => ['1p','2p','3p'].forEach(p => {
        const pd = pOdds[p]; if (!pd?.books?.length) return;
        const c = consensus(pd.books, pd.line); if (!c) return;
        pd.books.forEach(b => {
            if (!CFG.compareBooks.includes(b.bk?.toLowerCase())) return;
            if (b.overPrice) { const e = calcEV(b.overPrice, c.oP); if (e >= CFG.minEV) { cnt++; best = Math.max(best, e); } }
            if (b.underPrice) { const e = calcEV(b.underPrice, c.uP); if (e >= CFG.minEV) { cnt++; best = Math.max(best, e); } }
        });
    }));
    document.getElementById('sEV').textContent = cnt;
    document.getElementById('sBest').textContent = best > 0 ? '+' + best.toFixed(1) + '%' : '--';
}

function loadDemo() {
    alerted.clear();
    document.getElementById('debug').style.display = 'none';
    DATA = [
        {
            game: { eventID: 'd1', teams: {away: {names: {short: 'Golden Knights', abbr: 'VGK'}}, home: {names: {short: 'Kings', abbr: 'LAK'}}},
                status: {started: true, completed: false, currentPeriodID: '2p', inBreak: false} },
            pOdds: {'1p':{line:1.5,books:[]}, '2p':{line:1.5,books:[
                {bk:'pinnacle',line:1.5,overPrice:-125,underPrice:105},{bk:'circa',line:1.5,overPrice:-120,underPrice:100},{bk:'bookmaker',line:1.5,overPrice:-122,underPrice:102},
                {bk:'draftkings',line:1.5,overPrice:-135,underPrice:115},{bk:'fanduel',line:1.5,overPrice:-110,underPrice:-110},{bk:'betmgm',line:1.5,overPrice:-145,underPrice:125},{bk:'caesars',line:1.5,overPrice:-128,underPrice:108}
            ]}, '3p':{line:1.5,books:[]}}
        },
        {
            game: { eventID: 'd2', teams: {away: {names: {short: 'Canucks', abbr: 'VAN'}}, home: {names: {short: 'Blue Jackets', abbr: 'CBJ'}}},
                status: {started: false, completed: false, startsAt: new Date(Date.now() + 3600000).toISOString()} },
            pOdds: {'1p':{line:1.5,books:[
                {bk:'pinnacle',line:1.5,overPrice:-115,underPrice:-105},{bk:'circa',line:1.5,overPrice:-112,underPrice:-108},{bk:'bookmaker',line:1.5,overPrice:-110,underPrice:-110},
                {bk:'draftkings',line:1.5,overPrice:-125,underPrice:105},{bk:'fanduel',line:1.5,overPrice:-108,underPrice:-112},{bk:'betmgm',line:1.5,overPrice:110,underPrice:-130}
            ]}, '2p':{line:1.5,books:[]}, '3p':{line:1.5,books:[]}}
        }
    ];
    render();
    updateStats();
    setStatus(true, 'Demo');
}
</script>
</body>
</html>
