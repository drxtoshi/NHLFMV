<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHL Period Props | +EV Finder</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#06090d; --bg2:#0e141b; --bg3:#1a242f; --ice:#00d4ff; --profit:#00ff88; --loss:#ff4466; --warn:#ffbb00; --txt:#d8e0e8; --txt2:#7a8a9a; --txt3:#4a5a68; --bdr:rgba(255,255,255,0.06); }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--txt); min-height:100vh; }
        .app { max-width:1800px; margin:0 auto; padding:20px; }
        .header { display:flex; justify-content:space-between; align-items:center; padding-bottom:20px; border-bottom:1px solid var(--bdr); margin-bottom:20px; flex-wrap:wrap; gap:16px; }
        .logo { display:flex; align-items:center; gap:14px; }
        .logo-icon { width:44px; height:44px; background:linear-gradient(135deg,var(--ice),var(--profit)); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:22px; }
        .logo h1 { font-size:22px; background:linear-gradient(135deg,#fff,var(--ice)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .logo .sub { font-size:11px; color:var(--txt3); letter-spacing:1px; text-transform:uppercase; }
        .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
        .status { display:flex; align-items:center; gap:8px; padding:8px 14px; background:var(--bg2); border:1px solid var(--bdr); border-radius:8px; font-family:'IBM Plex Mono',monospace; font-size:12px; }
        .dot { width:8px; height:8px; border-radius:50%; background:var(--profit); box-shadow:0 0 8px var(--profit); animation:pulse 2s infinite; }
        .dot.off { background:var(--loss); box-shadow:0 0 8px var(--loss); animation:none; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .btn { padding:10px 18px; border:none; border-radius:8px; font-family:inherit; font-weight:600; font-size:13px; cursor:pointer; }
        .btn-p { background:var(--ice); color:var(--bg); }
        .btn-s { background:var(--bg3); color:var(--txt); border:1px solid var(--bdr); }
        .config { background:var(--bg2); border:1px solid var(--bdr); border-radius:12px; padding:20px; margin-bottom:20px; display:none; }
        .config.show { display:block; }
        .config-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:16px; }
        .field label { display:block; font-size:11px; color:var(--txt3); text-transform:uppercase; margin-bottom:6px; }
        .field input,.field select { width:100%; padding:10px; background:var(--bg); border:1px solid var(--bdr); border-radius:8px; color:var(--txt); font-family:'IBM Plex Mono',monospace; }
        .field select[multiple] { height:150px; }
        .field select option { padding:8px; }
        .field select option:checked { background:var(--ice); color:var(--bg); }
        .field-row { display:flex; gap:16px; }
        .field-row .field { flex:1; }
        .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:14px; margin-bottom:20px; }
        .stat { background:var(--bg2); border:1px solid var(--bdr); border-radius:10px; padding:16px; }
        .stat .l { font-size:10px; color:var(--txt3); text-transform:uppercase; margin-bottom:6px; }
        .stat .v { font-family:'IBM Plex Mono',monospace; font-size:24px; font-weight:700; }
        .stat .v.g { color:var(--profit); }
        .stat .v.c { color:var(--ice); }
        .games { display:flex; flex-direction:column; gap:20px; }
        .game { background:var(--bg2); border:1px solid var(--bdr); border-radius:14px; overflow:hidden; }
        .game.edge { border-color:var(--profit); box-shadow:0 0 30px rgba(0,255,136,0.1); }
        .game-head { display:flex; justify-content:space-between; align-items:center; padding:18px 22px; background:var(--bg3); border-bottom:1px solid var(--bdr); flex-wrap:wrap; gap:16px; }
        .matchup { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
        .team { display:flex; align-items:center; gap:10px; }
        .team-abbr { width:40px; height:40px; background:var(--bg); border-radius:8px; display:flex; align-items:center; justify-content:center; font-family:'IBM Plex Mono',monospace; font-weight:700; font-size:11px; color:var(--txt2); }
        .team-name { font-weight:600; }
        .team-score { font-family:'IBM Plex Mono',monospace; font-size:28px; font-weight:700; color:var(--ice); min-width:36px; text-align:center; }
        .vs { color:var(--txt3); }
        .game-status { text-align:right; }
        .period-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 14px; background:var(--ice); border-radius:16px; font-size:12px; font-weight:600; color:var(--bg); margin-bottom:6px; }
        .period-badge .live { width:6px; height:6px; background:var(--bg); border-radius:50%; animation:pulse 1s infinite; }
        .period-badge.intermission { background:var(--warn); }
        .time { font-family:'IBM Plex Mono',monospace; font-size:22px; font-weight:600; color:var(--warn); }
        .tabs { display:flex; gap:4px; padding:14px 22px; background:var(--bg); border-bottom:1px solid var(--bdr); }
        .tab { padding:8px 16px; background:transparent; border:1px solid var(--bdr); border-radius:6px; color:var(--txt2); font-family:inherit; font-size:12px; cursor:pointer; position:relative; }
        .tab:hover { border-color:var(--ice); color:var(--ice); }
        .tab.active { background:var(--ice); border-color:var(--ice); color:var(--bg); }
        .tab.has-edge::after { content:''; position:absolute; top:-3px; right:-3px; width:8px; height:8px; background:var(--profit); border-radius:50%; }
        .odds-section { padding:20px 22px; }
        .odds-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px; }
        .odds-title { font-size:14px; font-weight:600; }
        .consensus-box { display:flex; gap:20px; padding:10px 16px; background:var(--bg); border:1px solid var(--bdr); border-radius:8px; }
        .cons-item { text-align:center; }
        .cons-item .l { font-size:9px; color:var(--txt3); text-transform:uppercase; }
        .cons-item .v { font-family:'IBM Plex Mono',monospace; font-size:16px; font-weight:600; color:var(--ice); }
        .table-wrap { overflow-x:auto; }
        table { width:100%; border-collapse:collapse; min-width:700px; }
        th { padding:12px; text-align:left; font-size:10px; color:var(--txt3); text-transform:uppercase; background:var(--bg); border-bottom:1px solid var(--bdr); }
        td { padding:14px; border-bottom:1px solid var(--bdr); font-family:'IBM Plex Mono',monospace; font-size:13px; }
        tr:last-child td { border-bottom:none; }
        tr:hover { background:rgba(255,255,255,0.02); }
        .book-cell { display:flex; align-items:center; gap:10px; font-family:'Outfit',sans-serif; }
        .book-icon { width:26px; height:26px; background:var(--bg3); border-radius:5px; display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:700; color:var(--txt3); }
        .book-type { font-size:9px; padding:2px 5px; border-radius:3px; font-weight:600; }
        .book-type.sharp { background:rgba(0,255,136,0.12); color:var(--profit); }
        .book-type.soft { background:rgba(255,149,0,0.15); color:#ff9500; }
        .odds-cell { text-align:center; }
        .odds-val { display:inline-block; padding:5px 10px; border-radius:5px; font-weight:600; min-width:65px; }
        .odds-val.best { background:rgba(0,255,136,0.12); color:var(--profit); }
        .odds-val.worst { background:rgba(255,68,102,0.1); color:var(--loss); }
        .ev-cell { text-align:center; }
        .ev-val { display:inline-block; padding:5px 10px; border-radius:5px; font-weight:600; min-width:70px; }
        .ev-val.pos { background:rgba(0,255,136,0.12); color:var(--profit); }
        .ev-val.neg { color:var(--txt3); }
        .edge-tag { display:inline-flex; padding:4px 8px; background:var(--profit); color:var(--bg); border-radius:4px; font-size:10px; font-weight:700; font-family:'Outfit',sans-serif; }
        .cons-row { background:var(--bg3)!important; }
        .cons-row td { border-top:2px solid var(--ice)!important; }
        .cons-label { display:flex; align-items:center; gap:8px; font-family:'Outfit',sans-serif; font-weight:600; color:var(--ice); }
        .alerts { position:fixed; top:70px; right:20px; width:300px; max-height:50vh; overflow-y:auto; display:flex; flex-direction:column; gap:6px; z-index:100; }
        .alert { padding:10px 12px; background:var(--bg2); border:1px solid var(--profit); border-radius:8px; box-shadow:0 0 15px rgba(0,255,136,0.12); animation:slideIn 0.3s; cursor:pointer; transition:opacity 0.2s, transform 0.2s; }
        .alert:hover { transform:translateX(-3px); opacity:0.9; }
        @keyframes slideIn { from{opacity:0;transform:translateX(50px)} to{opacity:1;transform:translateX(0)} }
        .alert-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .alert-title { font-weight:600; color:var(--profit); font-size:11px; }
        .alert-time { font-size:9px; color:var(--txt3); font-family:'IBM Plex Mono',monospace; }
        .alert-content { font-size:11px; color:var(--txt2); line-height:1.4; }
        .alert-content strong { color:var(--txt); }
        .alert-ev { display:inline-block; margin-left:6px; padding:2px 6px; background:rgba(0,255,136,0.12); color:var(--profit); border-radius:3px; font-family:'IBM Plex Mono',monospace; font-weight:600; font-size:11px; }
        .empty { text-align:center; padding:60px 20px; color:var(--txt3); }
        .empty-icon { font-size:48px; margin-bottom:16px; }
        .empty h3 { font-size:18px; color:var(--txt2); margin-bottom:8px; }
        .loading { text-align:center; padding:40px; }
        .spinner { width:40px; height:40px; border:3px solid var(--bdr); border-top-color:var(--ice); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 16px; }
        @keyframes spin { to{transform:rotate(360deg)} }
        .debug { background:var(--bg2); border:1px solid var(--bdr); border-radius:8px; padding:12px; margin-top:20px; font-size:11px; font-family:'IBM Plex Mono',monospace; max-height:200px; overflow-y:auto; display:none; }
        .debug pre { white-space:pre-wrap; word-break:break-all; color:var(--txt2); }
        .help-text { font-size:10px; color:var(--txt3); margin-top:4px; }
    </style>
</head>
<body>
<div class="app">
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üèí</div>
            <div><h1>Period Props Edge</h1><div class="sub">Live Odds ‚Ä¢ Sharp Consensus ‚Ä¢ +EV Alerts</div></div>
        </div>
        <div class="controls">
            <div class="status"><div class="dot off" id="dot"></div><span id="statusTxt">Disconnected</span></div>
            <button class="btn btn-s" onclick="toggleConfig()">‚öôÔ∏è Settings</button>
            <button class="btn btn-p" onclick="fetchData()">‚Üª Refresh</button>
            <button class="btn btn-s" onclick="loadDemo()">Demo</button>
        </div>
    </header>
    <div class="config" id="config">
        <div class="config-grid">
            <div class="field"><label>SportsGame API Key</label><input type="password" id="apiKey" placeholder="Enter API key"></div>
            <div class="field"><label>Min EV Threshold (%)</label><input type="number" id="minEV" value="2" min="0" max="20" step="0.5"></div>
            <div class="field"><label>Auto Refresh (sec)</label><input type="number" id="refreshInt" value="30" min="10"></div>
            <div class="field"><label>Alert Sounds</label><select id="alertSound"><option value="on">Enabled</option><option value="off">Disabled</option></select></div>
            <div class="field">
                <label>Sharp Books (for Fair Value Consensus)</label>
                <select id="sharpBooks" multiple>
                    <option value="pinnacle" selected>Pinnacle</option>
                    <option value="circa" selected>Circa</option>
                    <option value="bookmaker" selected>Bookmaker</option>
                    <option value="betcris" selected>BetCRIS</option>
                    <option value="betonline" selected>BetOnline</option>
                    <option value="superbook">SuperBook</option>
                </select>
                <div class="help-text">Hold Ctrl/Cmd to select multiple. These books determine the fair odds.</div>
            </div>
            <div class="field">
                <label>Compare Books (check for +EV)</label>
                <select id="compareBooks" multiple>
                    <option value="draftkings" selected>DraftKings</option>
                    <option value="fanduel" selected>FanDuel</option>
                    <option value="betmgm" selected>BetMGM</option>
                    <option value="caesars" selected>Caesars</option>
                    <option value="pointsbet" selected>PointsBet</option>
                    <option value="betrivers" selected>BetRivers</option>
                    <option value="bet365">Bet365</option>
                    <option value="espnbet">ESPN Bet</option>
                    <option value="fanatics">Fanatics</option>
                    <option value="pinnacle">Pinnacle</option>
                    <option value="circa">Circa</option>
                    <option value="bookmaker">Bookmaker</option>
                    <option value="betonline">BetOnline</option>
                </select>
                <div class="help-text">Hold Ctrl/Cmd to select multiple. These books are checked for +EV opportunities.</div>
            </div>
        </div>
    </div>
    <div class="stats">
        <div class="stat"><div class="l">Live Games</div><div class="v c" id="sGames">0</div></div>
        <div class="stat"><div class="l">+EV Opps</div><div class="v g" id="sEV">0</div></div>
        <div class="stat"><div class="l">Best Edge</div><div class="v g" id="sBest">--</div></div>
        <div class="stat"><div class="l">Last Update</div><div class="v" id="sTime" style="font-size:16px">--</div></div>
    </div>
    <div class="games" id="games"><div class="loading"><div class="spinner"></div><div>Enter API key & Refresh, or click Demo</div></div></div>
    <div class="debug" id="debug"><strong>Debug:</strong><pre id="log"></pre></div>
</div>
<div class="alerts" id="alerts"></div>
<script>
const CFG = {
    apiKey: '',
    minEV: 2,
    refresh: 30,
    sound: true,
    sharpBooks: ['pinnacle','circa','bookmaker','betcris','betonline'],
    compareBooks: ['draftkings','fanduel','betmgm','caesars','pointsbet','betrivers']
};

const BOOKS = {
    pinnacle:{n:'Pinnacle',a:'PIN',t:'sharp'},
    circa:{n:'Circa',a:'CIR',t:'sharp'},
    bookmaker:{n:'Bookmaker',a:'BKM',t:'sharp'},
    betcris:{n:'BetCRIS',a:'CRS',t:'sharp'},
    betonline:{n:'BetOnline',a:'BOL',t:'sharp'},
    superbook:{n:'SuperBook',a:'SUP',t:'sharp'},
    draftkings:{n:'DraftKings',a:'DK',t:'soft'},
    fanduel:{n:'FanDuel',a:'FD',t:'soft'},
    betmgm:{n:'BetMGM',a:'MGM',t:'soft'},
    caesars:{n:'Caesars',a:'CZR',t:'soft'},
    pointsbet:{n:'PointsBet',a:'PB',t:'soft'},
    betrivers:{n:'BetRivers',a:'BR',t:'soft'},
    bet365:{n:'Bet365',a:'365',t:'soft'},
    espnbet:{n:'ESPN Bet',a:'ESPN',t:'soft'},
    fanatics:{n:'Fanatics',a:'FAN',t:'soft'}
};

let DATA = [], alerted = new Set(), timer = null;

function log(m) {
    const d = document.getElementById('log');
    d.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`;
    console.log(m);
}

document.addEventListener('DOMContentLoaded', () => {
    loadCfg();
    const k = localStorage.getItem('sgKey');
    if (k) { document.getElementById('apiKey').value = k; CFG.apiKey = k; }
});

function loadCfg() {
    const s = localStorage.getItem('ppCfg');
    if (s) {
        const p = JSON.parse(s);
        Object.assign(CFG, p);
        document.getElementById('minEV').value = CFG.minEV;
        document.getElementById('refreshInt').value = CFG.refresh;
        document.getElementById('alertSound').value = CFG.sound ? 'on' : 'off';
        // Set multiselects
        setMultiSelect('sharpBooks', CFG.sharpBooks);
        setMultiSelect('compareBooks', CFG.compareBooks);
    }
}

function setMultiSelect(id, values) {
    const sel = document.getElementById(id);
    Array.from(sel.options).forEach(opt => {
        opt.selected = values.includes(opt.value);
    });
}

function getMultiSelect(id) {
    const sel = document.getElementById(id);
    return Array.from(sel.selectedOptions).map(o => o.value);
}

function saveCfg() {
    CFG.apiKey = document.getElementById('apiKey').value;
    CFG.minEV = parseFloat(document.getElementById('minEV').value);
    CFG.refresh = parseInt(document.getElementById('refreshInt').value);
    CFG.sound = document.getElementById('alertSound').value === 'on';
    CFG.sharpBooks = getMultiSelect('sharpBooks');
    CFG.compareBooks = getMultiSelect('compareBooks');
    localStorage.setItem('sgKey', CFG.apiKey);
    localStorage.setItem('ppCfg', JSON.stringify({
        minEV: CFG.minEV,
        refresh: CFG.refresh,
        sound: CFG.sound,
        sharpBooks: CFG.sharpBooks,
        compareBooks: CFG.compareBooks
    }));
}

function toggleConfig() { document.getElementById('config').classList.toggle('show'); }
function setStatus(on, txt) {
    document.getElementById('dot').className = 'dot' + (on ? '' : ' off');
    document.getElementById('statusTxt').textContent = txt;
}

async function fetchData() {
    saveCfg();
    if (!CFG.apiKey) { alert('Enter API key in Settings'); toggleConfig(); return; }
    document.getElementById('debug').style.display = 'block';
    document.getElementById('log').textContent = '';
    setStatus(false, 'Fetching...');
    document.getElementById('games').innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading...</div></div>';
    
    try {
        const periodOddIDs = [
            'points-all-1p-ou-over','points-all-1p-ou-under',
            'points-all-2p-ou-over','points-all-2p-ou-under',
            'points-all-3p-ou-over','points-all-3p-ou-under'
        ].join(',');
        
        const url = `https://api.sportsgameodds.com/v2/events?apiKey=${CFG.apiKey}&leagueID=NHL&oddsAvailable=true&includeOpposingOdds=true&oddIDs=${periodOddIDs}`;
        log('Fetching: ' + url.replace(CFG.apiKey, '***'));
        
        const res = await fetch(url);
        if (!res.ok) { const e = await res.text(); log('Error ' + res.status + ': ' + e); throw new Error('API Error ' + res.status); }
        
        const json = await res.json();
        log('Got ' + ((json.data || []).length) + ' events');
        
        const events = json.data || [];
        const live = events.filter(e => {
            const a = e.activity || {};
            return a.isLive || (a.started && !a.ended);
        });
        log('Live: ' + live.length);
        
        // Log first event structure for debugging
        if (events.length > 0) {
            const e = events[0];
            log('Event structure keys: ' + Object.keys(e).join(', '));
            if (e.score) log('Score structure: ' + JSON.stringify(e.score));
            if (e.activity) log('Activity structure: ' + JSON.stringify(e.activity));
            if (e.status) log('Status: ' + JSON.stringify(e.status));
        }
        
        DATA = (live.length ? live : events.slice(0, 5)).map(e => ({
            game: e,
            pOdds: extractOdds(e.odds || {})
        }));
        
        log('Processed ' + DATA.length + ' games');
        
        render();
        updateStats();
        setStatus(true, live.length ? 'Connected' : 'Connected (No Live)');
        if (timer) clearInterval(timer);
        timer = setInterval(fetchData, CFG.refresh * 1000);
    } catch (err) {
        log('Error: ' + err.message);
        setStatus(false, 'Error');
        document.getElementById('games').innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><h3>Error</h3><p>${err.message}</p></div>`;
    }
}

function extractOdds(odds) {
    const r = {'1p':{line:1.5,books:[]}, '2p':{line:1.5,books:[]}, '3p':{line:1.5,books:[]}};
    
    for (const [id, o] of Object.entries(odds)) {
        // Match: points-all-1p-ou-over/under or similar
        let m = id.match(/(points|goals)-all-(1p|2p|3p|p1|p2|p3|1st|2nd|3rd)-ou-(over|under)/i);
        if (!m) continue;
        
        let period = m[2].toLowerCase();
        if (period === 'p1' || period === '1st') period = '1p';
        if (period === 'p2' || period === '2nd') period = '2p';
        if (period === 'p3' || period === '3rd') period = '3p';
        
        const side = m[3].toLowerCase();
        const line = parseFloat(o.bookOverUnder || o.fairOverUnder) || 1.5;
        r[period].line = line;
        
        if (o.byBookmaker) {
            for (const [bk, bd] of Object.entries(o.byBookmaker)) {
                if (!bd.available) continue;
                let be = r[period].books.find(x => x.bk === bk);
                if (!be) {
                    be = {bk, line: parseFloat(bd.overUnder) || line};
                    r[period].books.push(be);
                }
                be[side + 'Price'] = parseInt(bd.odds);
            }
        }
    }
    
    ['1p','2p','3p'].forEach(p => {
        if (r[p].books.length) log(`Period ${p}: ${r[p].books.length} books, line ${r[p].line}`);
    });
    
    return r;
}

// Math helpers
function a2d(a) { return a >= 100 ? (a/100) + 1 : (100/Math.abs(a)) + 1; }
function a2p(a) { return a >= 100 ? 100/(a+100) : Math.abs(a)/(Math.abs(a)+100); }
function noVig(o, u) { const op = a2p(o), up = a2p(u), t = op + up; return {o: op/t, u: up/t}; }
function p2a(p) { return p >= 0.5 ? Math.round(-100*p/(1-p)) : Math.round(100*(1-p)/p); }
function calcEV(odds, fp) { return ((fp * a2d(odds)) - 1) * 100; }

function consensus(books, line) {
    // Only use selected sharp books
    const sb = books.filter(b => CFG.sharpBooks.includes(b.bk?.toLowerCase()) && b.overPrice && b.underPrice);
    if (!sb.length) return null;
    let to = 0, tu = 0;
    sb.forEach(b => { const nv = noVig(b.overPrice, b.underPrice); to += nv.o; tu += nv.u; });
    const ao = to/sb.length, au = tu/sb.length;
    return {oP: ao, uP: au, oFair: p2a(ao), uFair: p2a(au), line, cnt: sb.length};
}

function render() {
    const c = document.getElementById('games');
    if (!DATA.length) { c.innerHTML = '<div class="empty"><div class="empty-icon">üèí</div><h3>No Games</h3><p>Click Demo to see sample</p></div>'; return; }
    c.innerHTML = DATA.map(({game: g, pOdds}) => {
        const edge = hasEdge(pOdds);
        return `<div class="game${edge ? ' edge' : ''}" id="g-${g.eventID}">${gameHead(g)}${tabs(g, pOdds)}${oddsSection(g, pOdds)}</div>`;
    }).join('');
}

function gameHead(g) {
    const t = g.teams || {};
    const aw = t.away || {};
    const hm = t.home || {};
    
    // Parse team names/abbrs
    const awA = aw.names?.abbr || aw.teamID?.split('_')[0] || 'AWY';
    const hmA = hm.names?.abbr || hm.teamID?.split('_')[0] || 'HME';
    const awN = aw.names?.short || aw.names?.long || aw.teamID?.replace('_NHL','') || 'Away';
    const hmN = hm.names?.short || hm.names?.long || hm.teamID?.replace('_NHL','') || 'Home';
    
    // Parse score - check multiple possible locations
    let awS = 0, hmS = 0;
    const score = g.score || {};
    // Try score.away.total, score.away, or direct
    if (typeof score.away === 'object') awS = score.away.total ?? score.away.score ?? 0;
    else if (typeof score.away === 'number') awS = score.away;
    if (typeof score.home === 'object') hmS = score.home.total ?? score.home.score ?? 0;
    else if (typeof score.home === 'number') hmS = score.home;
    // Also check results field
    if (g.results) {
        const pts = g.results['points-all-game-ou-over'] || g.results['points'] || {};
        if (pts.away !== undefined) awS = pts.away;
        if (pts.home !== undefined) hmS = pts.home;
    }
    
    // Parse activity/status
    const a = g.activity || g.status || {};
    let per = a.period || a.currentPeriod || a.inningNumber || 0;
    let clk = a.clock || a.time || a.timeRemaining || '';
    const live = a.isLive || a.started || a.status === 'in_progress' || a.status === 'live';
    const intermission = a.isIntermission || a.intermission || false;
    
    // Check for period in different formats
    if (!per && a.periodNumber) per = a.periodNumber;
    if (!per && g.status?.period) per = g.status.period;
    
    // Format clock
    if (clk && typeof clk === 'number') clk = formatClock(clk);
    
    return `<div class="game-head">
        <div class="matchup">
            <div class="team">
                <div class="team-abbr">${awA}</div>
                <span class="team-name">${awN}</span>
                <span class="team-score">${awS}</span>
            </div>
            <span class="vs">@</span>
            <div class="team">
                <span class="team-score">${hmS}</span>
                <span class="team-name">${hmN}</span>
                <div class="team-abbr">${hmA}</div>
            </div>
        </div>
        <div class="game-status">
            ${live ? `
                <div class="period-badge${intermission ? ' intermission' : ''}">
                    <span class="live"></span>
                    ${intermission ? 'INT' : 'P' + per}
                </div>
                <div class="time">${clk || '--:--'}</div>
            ` : '<span style="color:var(--txt3)">Upcoming</span>'}
        </div>
    </div>`;
}

function formatClock(seconds) {
    if (typeof seconds !== 'number') return seconds;
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s.toString().padStart(2, '0')}`;
}

function tabs(g, pOdds) {
    const a = g.activity || g.status || {};
    const cp = a.period || a.currentPeriod || 1;
    return `<div class="tabs">${['1p','2p','3p'].map((p, i) => {
        const n = i + 1;
        const has = pOdds[p]?.books?.length > 0;
        const edge = has && pEdge(pOdds[p]);
        const act = n === cp;
        return `<button class="tab${act ? ' active' : ''}${edge ? ' has-edge' : ''}" data-p="${p}" onclick="switchP(this,'${g.eventID}')"${!has ? ' style="opacity:0.4"' : ''}>P${n}${act ? ' (Live)' : ''}${has ? '' : ' (No Odds)'}</button>`;
    }).join('')}</div>`;
}

function switchP(btn, gid) {
    btn.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    const gd = DATA.find(d => d.game.eventID === gid);
    if (gd) {
        const sec = document.querySelector('#g-' + gid + ' .odds-section');
        if (sec) sec.outerHTML = oddsSection(gd.game, gd.pOdds, btn.dataset.p);
    }
}

function oddsSection(g, pOdds, selP = null) {
    const a = g.activity || g.status || {};
    const cp = selP || ((a.period || 1) + 'p');
    const pd = pOdds[cp] || {line: 1.5, books: []};
    const cons = consensus(pd.books, pd.line);
    return `<div class="odds-section">
        <div class="odds-head">
            <div class="odds-title">üìä Period ${cp.replace('p','')} Total</div>
            ${cons ? `<div class="consensus-box">
                <div class="cons-item"><div class="l">Line</div><div class="v">${cons.line}</div></div>
                <div class="cons-item"><div class="l">Fair O</div><div class="v">${fmt(cons.oFair)}</div></div>
                <div class="cons-item"><div class="l">Fair U</div><div class="v">${fmt(cons.uFair)}</div></div>
                <div class="cons-item"><div class="l">Sharp#</div><div class="v">${cons.cnt}</div></div>
            </div>` : '<span style="color:var(--txt3)">No sharp book data</span>'}
        </div>
        <div class="table-wrap">${oddsTable(pd, cons, g)}</div>
    </div>`;
}

function oddsTable(pd, cons, g) {
    if (!pd.books.length) return '<div class="loading">No odds available</div>';
    
    // Filter to only show compare books + sharp books
    const showBooks = [...new Set([...CFG.sharpBooks, ...CFG.compareBooks])];
    const filteredBooks = pd.books.filter(b => showBooks.includes(b.bk?.toLowerCase()));
    
    if (!filteredBooks.length) return '<div class="loading">No odds from selected books</div>';
    
    let bo = -Infinity, bu = -Infinity, wo = Infinity, wu = Infinity;
    filteredBooks.forEach(b => {
        if (b.overPrice) { bo = Math.max(bo, b.overPrice); wo = Math.min(wo, b.overPrice); }
        if (b.underPrice) { bu = Math.max(bu, b.underPrice); wu = Math.min(wu, b.underPrice); }
    });
    
    const sorted = [...filteredBooks].sort((a, b) => {
        const aSharp = CFG.sharpBooks.includes(a.bk?.toLowerCase()) ? 0 : 1;
        const bSharp = CFG.sharpBooks.includes(b.bk?.toLowerCase()) ? 0 : 1;
        return aSharp - bSharp;
    });
    
    return `<table><thead><tr>
        <th>Book</th><th>Line</th><th style="text-align:center">Over</th><th style="text-align:center">Under</th>
        <th style="text-align:center">O EV</th><th style="text-align:center">U EV</th><th>Signal</th>
    </tr></thead><tbody>
        ${cons ? `<tr class="cons-row">
            <td><div class="cons-label">‚ö° Sharp Consensus (${cons.cnt})</div></td>
            <td>${cons.line}</td>
            <td class="odds-cell"><span class="odds-val">${fmt(cons.oFair)}</span></td>
            <td class="odds-cell"><span class="odds-val">${fmt(cons.uFair)}</span></td>
            <td>--</td><td>--</td><td style="color:var(--ice)">Fair</td>
        </tr>` : ''}
        ${sorted.map(b => oddsRow(b, cons, bo, bu, wo, wu, g, filteredBooks.length)).join('')}
    </tbody></table>`;
}

function oddsRow(b, cons, bo, bu, wo, wu, g, tot) {
    const bk = (b.bk || '').toLowerCase();
    const bkd = BOOKS[bk] || {n: b.bk || bk, a: bk.substring(0,3).toUpperCase(), t: 'soft'};
    const isSharp = CFG.sharpBooks.includes(bk);
    const isCompare = CFG.compareBooks.includes(bk);
    
    const o = b.overPrice, u = b.underPrice, ln = b.line || 1.5;
    let oEV = null, uEV = null;
    
    // Only calculate EV for compare books
    if (cons && isCompare) {
        if (o) oEV = calcEV(o, cons.oP);
        if (u) uEV = calcEV(u, cons.uP);
    }
    
    const oE = oEV && oEV >= CFG.minEV;
    const uE = uEV && uEV >= CFG.minEV;
    
    if (oE || uE) {
        const k = `${g.eventID}-${bk}-${ln}-${o}-${u}`;
        if (!alerted.has(k)) { alerted.add(k); triggerAlert(g, bkd, b, oEV, uEV, oE, uE); }
    }
    
    return `<tr>
        <td><div class="book-cell">
            <div class="book-icon">${bkd.a}</div>
            <span>${bkd.n}</span>
            <span class="book-type ${isSharp ? 'sharp' : 'soft'}">${isSharp ? 'SHARP' : 'SOFT'}</span>
        </div></td>
        <td>${ln}</td>
        <td class="odds-cell">${o ? `<span class="odds-val${o === bo ? ' best' : ''}${o === wo && tot > 2 ? ' worst' : ''}">${fmt(o)}</span>` : '--'}</td>
        <td class="odds-cell">${u ? `<span class="odds-val${u === bu ? ' best' : ''}${u === wu && tot > 2 ? ' worst' : ''}">${fmt(u)}</span>` : '--'}</td>
        <td class="ev-cell">${oEV !== null ? `<span class="ev-val${oEV >= CFG.minEV ? ' pos' : ' neg'}">${oEV > 0 ? '+' : ''}${oEV.toFixed(1)}%</span>` : '--'}</td>
        <td class="ev-cell">${uEV !== null ? `<span class="ev-val${uEV >= CFG.minEV ? ' pos' : ' neg'}">${uEV > 0 ? '+' : ''}${uEV.toFixed(1)}%</span>` : '--'}</td>
        <td>${oE ? `<span class="edge-tag">üî• O +${oEV.toFixed(1)}%</span>` : ''}${uE ? `<span class="edge-tag">üî• U +${uEV.toFixed(1)}%</span>` : ''}${!oE && !uE ? (isSharp ? '<span style="color:var(--txt3)">‚Äî</span>' : '‚Äî') : ''}</td>
    </tr>`;
}

function fmt(a) { return a == null ? '--' : (a > 0 ? '+' + a : a); }
function hasEdge(po) { return ['1p','2p','3p'].some(p => pEdge(po[p])); }
function pEdge(pd) {
    if (!pd?.books?.length) return false;
    const c = consensus(pd.books, pd.line);
    if (!c) return false;
    return pd.books.some(b => {
        if (!CFG.compareBooks.includes(b.bk?.toLowerCase())) return false;
        return (b.overPrice && calcEV(b.overPrice, c.oP) >= CFG.minEV) || (b.underPrice && calcEV(b.underPrice, c.uP) >= CFG.minEV);
    });
}

function triggerAlert(g, bkd, b, oEV, uEV, oE, uE) {
    const c = document.getElementById('alerts');
    const tm = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const t = g.teams || {};
    const aw = t.away?.names?.abbr || t.away?.teamID?.split('_')[0] || 'AWY';
    const hm = t.home?.names?.abbr || t.home?.teamID?.split('_')[0] || 'HME';
    const side = oE && (!uE || oEV > uEV) ? `O ${b.line}` : `U ${b.line}`;
    const ev = oE && (!uE || oEV > uEV) ? oEV : uEV;
    const pr = oE && (!uE || oEV > uEV) ? b.overPrice : b.underPrice;
    const id = 'a' + Date.now();
    c.insertAdjacentHTML('afterbegin', `<div class="alert" id="${id}" onclick="dismissAlert('${id}')">
        <div class="alert-head">
            <span class="alert-title">üî• ${aw}@${hm}</span>
            <span class="alert-time">${tm}</span>
        </div>
        <div class="alert-content">
            ${bkd.n}: <strong>${side}</strong> ${fmt(pr)}<span class="alert-ev">+${ev.toFixed(1)}%</span>
        </div>
    </div>`);
    if (CFG.sound) beep();
    setTimeout(() => dismissAlert(id), 120000);
}

function dismissAlert(id) { const a = document.getElementById(id); if (a) { a.style.opacity = '0'; setTimeout(() => a.remove(), 300); } }
function beep() {
    try {
        const x = new (window.AudioContext || window.webkitAudioContext)();
        const o = x.createOscillator(), g = x.createGain();
        o.connect(g); g.connect(x.destination);
        o.frequency.value = 880;
        g.gain.setValueAtTime(0.2, x.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, x.currentTime + 0.2);
        o.start(x.currentTime); o.stop(x.currentTime + 0.2);
    } catch(e) {}
}

function updateStats() {
    document.getElementById('sGames').textContent = DATA.length;
    document.getElementById('sTime').textContent = new Date().toLocaleTimeString();
    let cnt = 0, best = 0;
    DATA.forEach(({pOdds}) => ['1p','2p','3p'].forEach(p => {
        const pd = pOdds[p];
        if (!pd?.books?.length) return;
        const c = consensus(pd.books, pd.line);
        if (!c) return;
        pd.books.forEach(b => {
            if (!CFG.compareBooks.includes(b.bk?.toLowerCase())) return;
            if (b.overPrice) { const e = calcEV(b.overPrice, c.oP); if (e >= CFG.minEV) { cnt++; best = Math.max(best, e); } }
            if (b.underPrice) { const e = calcEV(b.underPrice, c.uP); if (e >= CFG.minEV) { cnt++; best = Math.max(best, e); } }
        });
    }));
    document.getElementById('sEV').textContent = cnt;
    document.getElementById('sBest').textContent = best > 0 ? '+' + best.toFixed(1) + '%' : '--';
}

function loadDemo() {
    alerted.clear();
    document.getElementById('debug').style.display = 'none';
    DATA = [
        {
            game: {
                eventID: 'd1',
                teams: {away: {names: {short: 'Golden Knights', abbr: 'VGK'}}, home: {names: {short: 'Kings', abbr: 'LAK'}}},
                score: {away: {total: 2}, home: {total: 2}},
                activity: {isLive: true, period: 2, clock: '08:32', started: true}
            },
            pOdds: {
                '1p': {line: 1.5, books: []},
                '2p': {line: 1.5, books: [
                    {bk: 'pinnacle', line: 1.5, overPrice: -125, underPrice: 105},
                    {bk: 'circa', line: 1.5, overPrice: -120, underPrice: 100},
                    {bk: 'bookmaker', line: 1.5, overPrice: -122, underPrice: 102},
                    {bk: 'betcris', line: 1.5, overPrice: -118, underPrice: -102},
                    {bk: 'draftkings', line: 1.5, overPrice: -130, underPrice: 110},
                    {bk: 'fanduel', line: 1.5, overPrice: -110, underPrice: -110},
                    {bk: 'betmgm', line: 1.5, overPrice: -140, underPrice: 120},
                    {bk: 'caesars', line: 1.5, overPrice: -128, underPrice: 108}
                ]},
                '3p': {line: 1.5, books: []}
            }
        },
        {
            game: {
                eventID: 'd2',
                teams: {away: {names: {short: 'Canucks', abbr: 'VAN'}}, home: {names: {short: 'Blue Jackets', abbr: 'CBJ'}}},
                score: {away: {total: 1}, home: {total: 3}},
                activity: {isLive: true, period: 3, clock: '12:15', started: true}
            },
            pOdds: {
                '1p': {line: 1.5, books: []},
                '2p': {line: 1.5, books: []},
                '3p': {line: 2.5, books: [
                    {bk: 'pinnacle', line: 2.5, overPrice: -108, underPrice: -112},
                    {bk: 'circa', line: 2.5, overPrice: -105, underPrice: -115},
                    {bk: 'bookmaker', line: 2.5, overPrice: -110, underPrice: -110},
                    {bk: 'betonline', line: 2.5, overPrice: -108, underPrice: -112},
                    {bk: 'draftkings', line: 2.5, overPrice: -120, underPrice: 100},
                    {bk: 'fanduel', line: 2.5, overPrice: -105, underPrice: -115},
                    {bk: 'betmgm', line: 2.5, overPrice: 105, underPrice: -125}
                ]}
            }
        }
    ];
    render();
    updateStats();
    setStatus(true, 'Demo Mode');
}
</script>
</body>
</html>
