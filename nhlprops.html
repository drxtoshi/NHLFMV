<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHL Period Props | +EV Finder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-void: #06090d;
            --bg-primary: #0b1017;
            --bg-secondary: #111921;
            --bg-tertiary: #1a242f;
            --bg-card: #0e141b;
            --bg-hover: #192430;
            --accent-ice: #00d4ff;
            --accent-ice-dim: rgba(0, 212, 255, 0.12);
            --accent-profit: #00ff88;
            --accent-profit-dim: rgba(0, 255, 136, 0.12);
            --accent-loss: #ff4466;
            --accent-loss-dim: rgba(255, 68, 102, 0.1);
            --accent-warning: #ffbb00;
            --accent-sharp: #00ff88;
            --accent-soft: #ff9500;
            --text-bright: #ffffff;
            --text-primary: #d8e0e8;
            --text-secondary: #7a8a9a;
            --text-muted: #4a5a68;
            --border-subtle: rgba(255, 255, 255, 0.05);
            --border-normal: rgba(255, 255, 255, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-void);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .app { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .logo { display: flex; align-items: center; gap: 14px; }
        .logo-icon {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--accent-ice), var(--accent-profit));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
        }
        .logo h1 {
            font-size: 22px; font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--accent-ice));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .logo .sub {
            font-size: 11px; color: var(--text-muted);
            font-weight: 500; letter-spacing: 1px; text-transform: uppercase;
        }
        .header-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .status {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 14px; background: var(--bg-secondary);
            border: 1px solid var(--border-subtle); border-radius: 8px;
            font-family: 'IBM Plex Mono', monospace; font-size: 12px;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--accent-profit);
            box-shadow: 0 0 8px var(--accent-profit);
            animation: pulse 2s infinite;
        }
        .status-dot.off {
            background: var(--accent-loss);
            box-shadow: 0 0 8px var(--accent-loss);
            animation: none;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .btn {
            padding: 10px 18px; border: none; border-radius: 8px;
            font-family: inherit; font-weight: 600; font-size: 13px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: var(--accent-ice); color: var(--bg-void); }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
        .btn-secondary {
            background: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border-normal);
        }
        .btn-secondary:hover { border-color: var(--accent-ice); }
        .config-panel {
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none;
        }
        .config-panel.show { display: block; }
        .config-title {
            font-size: 12px; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .config-field label {
            display: block; font-size: 11px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
        }
        .config-field input, .config-field select {
            width: 100%; padding: 10px 14px; background: var(--bg-secondary);
            border: 1px solid var(--border-subtle); border-radius: 8px;
            color: var(--text-primary); font-family: 'IBM Plex Mono', monospace; font-size: 13px;
        }
        .config-field input:focus, .config-field select:focus {
            outline: none; border-color: var(--accent-ice);
        }
        .books-selector { grid-column: 1 / -1; }
        .books-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .book-chip {
            padding: 6px 14px; background: var(--bg-secondary);
            border: 1px solid var(--border-subtle); border-radius: 20px;
            font-size: 12px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .book-chip .tag {
            font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600;
        }
        .book-chip.sharp .tag { background: var(--accent-profit-dim); color: var(--accent-sharp); }
        .book-chip.soft .tag { background: rgba(255, 149, 0, 0.15); color: var(--accent-soft); }
        .book-chip.selected { border-color: var(--accent-ice); background: var(--accent-ice-dim); }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px; margin-bottom: 20px;
        }
        .stat-box {
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: 10px; padding: 16px;
        }
        .stat-box .label {
            font-size: 10px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
        }
        .stat-box .value { font-family: 'IBM Plex Mono', monospace; font-size: 26px; font-weight: 700; }
        .stat-box .value.green { color: var(--accent-profit); }
        .stat-box .value.cyan { color: var(--accent-ice); }
        .games-list { display: flex; flex-direction: column; gap: 20px; }
        .game-card {
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: 14px; overflow: hidden;
        }
        .game-card.has-edge {
            border-color: var(--accent-profit);
            box-shadow: 0 0 30px var(--accent-profit-dim);
        }
        .game-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 22px; background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap; gap: 16px;
        }
        .matchup { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .team { display: flex; align-items: center; gap: 10px; }
        .team-abbr {
            width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'IBM Plex Mono', monospace; font-weight: 700; font-size: 11px;
            color: var(--text-secondary);
        }
        .team-name { font-weight: 600; font-size: 15px; }
        .team-score {
            font-family: 'IBM Plex Mono', monospace; font-size: 28px; font-weight: 700;
            color: var(--accent-ice); min-width: 40px; text-align: center;
        }
        .vs { color: var(--text-muted); font-size: 13px; }
        .game-status { text-align: right; }
        .period-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 14px; background: var(--accent-ice); border-radius: 16px;
            font-size: 12px; font-weight: 600; color: var(--bg-void); margin-bottom: 6px;
        }
        .period-badge .live-dot {
            width: 6px; height: 6px; background: var(--bg-void);
            border-radius: 50%; animation: pulse 1s infinite;
        }
        .time-left {
            font-family: 'IBM Plex Mono', monospace; font-size: 22px;
            font-weight: 600; color: var(--accent-warning);
        }
        .period-tabs {
            display: flex; gap: 4px; padding: 14px 22px;
            background: var(--bg-primary); border-bottom: 1px solid var(--border-subtle);
        }
        .period-tab {
            padding: 8px 16px; background: transparent;
            border: 1px solid var(--border-subtle); border-radius: 6px;
            color: var(--text-secondary); font-family: inherit;
            font-size: 12px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; position: relative;
        }
        .period-tab:hover { border-color: var(--accent-ice); color: var(--accent-ice); }
        .period-tab.active {
            background: var(--accent-ice); border-color: var(--accent-ice); color: var(--bg-void);
        }
        .period-tab.has-edge::after {
            content: ''; position: absolute; top: -3px; right: -3px;
            width: 8px; height: 8px; background: var(--accent-profit);
            border-radius: 50%; box-shadow: 0 0 6px var(--accent-profit);
        }
        .odds-section { padding: 20px 22px; }
        .odds-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; flex-wrap: wrap; gap: 12px;
        }
        .odds-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .consensus-box {
            display: flex; gap: 20px; padding: 10px 16px;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: 8px; flex-wrap: wrap;
        }
        .consensus-item { text-align: center; }
        .consensus-item .lbl {
            font-size: 9px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .consensus-item .val {
            font-family: 'IBM Plex Mono', monospace; font-size: 16px;
            font-weight: 600; color: var(--accent-ice);
        }
        .odds-table-wrap { overflow-x: auto; }
        .odds-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .odds-table th {
            padding: 12px 14px; text-align: left; font-size: 10px; font-weight: 600;
            color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
            background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle);
        }
        .odds-table td {
            padding: 14px; border-bottom: 1px solid var(--border-subtle);
            font-family: 'IBM Plex Mono', monospace; font-size: 13px;
        }
        .odds-table tr:last-child td { border-bottom: none; }
        .odds-table tr:hover { background: var(--bg-hover); }
        .book-cell {
            display: flex; align-items: center; gap: 10px; font-family: 'Outfit', sans-serif;
        }
        .book-icon {
            width: 26px; height: 26px; background: var(--bg-tertiary); border-radius: 5px;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 700; color: var(--text-muted);
        }
        .book-type { font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600; }
        .book-type.sharp { background: var(--accent-profit-dim); color: var(--accent-sharp); }
        .book-type.soft { background: rgba(255, 149, 0, 0.15); color: var(--accent-soft); }
        .odds-cell { text-align: center; }
        .odds-val {
            display: inline-block; padding: 5px 10px; border-radius: 5px;
            font-weight: 600; min-width: 65px;
        }
        .odds-val.best { background: var(--accent-profit-dim); color: var(--accent-profit); }
        .odds-val.worst { background: var(--accent-loss-dim); color: var(--accent-loss); }
        .ev-cell { text-align: center; }
        .ev-val {
            display: inline-block; padding: 5px 10px; border-radius: 5px;
            font-weight: 600; min-width: 70px;
        }
        .ev-val.pos { background: var(--accent-profit-dim); color: var(--accent-profit); }
        .ev-val.neg { color: var(--text-muted); }
        .edge-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 8px; background: var(--accent-profit); color: var(--bg-void);
            border-radius: 4px; font-size: 10px; font-weight: 700;
            font-family: 'Outfit', sans-serif; white-space: nowrap;
        }
        .consensus-row { background: var(--bg-tertiary) !important; }
        .consensus-row td { border-top: 2px solid var(--accent-ice) !important; }
        .consensus-label {
            display: flex; align-items: center; gap: 8px;
            font-family: 'Outfit', sans-serif; font-weight: 600; color: var(--accent-ice);
        }
        .alerts-container {
            position: fixed; bottom: 20px; right: 20px; width: 360px;
            max-height: 400px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px; z-index: 100;
        }
        .alert {
            padding: 14px 18px; background: var(--bg-card);
            border: 1px solid var(--accent-profit); border-radius: 10px;
            box-shadow: 0 0 20px var(--accent-profit-dim); animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .alert-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
        }
        .alert-title { font-weight: 600; color: var(--accent-profit); font-size: 13px; }
        .alert-time { font-size: 10px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; }
        .alert-close {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; font-size: 16px; padding: 0; margin-left: 10px;
        }
        .alert-content { font-size: 13px; color: var(--text-secondary); }
        .alert-content strong { color: var(--text-bright); }
        .alert-ev {
            display: inline-block; margin-top: 6px; padding: 3px 8px;
            background: var(--accent-profit-dim); color: var(--accent-profit);
            border-radius: 4px; font-family: 'IBM Plex Mono', monospace;
            font-weight: 600; font-size: 13px;
        }
        .no-games { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .no-games-icon { font-size: 48px; margin-bottom: 16px; }
        .no-games h3 { font-size: 18px; margin-bottom: 8px; color: var(--text-secondary); }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .spinner {
            width: 40px; height: 40px; border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-ice); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; }
            .matchup { flex-direction: column; }
            .alerts-container { width: calc(100% - 40px); left: 20px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üèí</div>
                <div>
                    <h1>Period Props Edge</h1>
                    <div class="sub">Live Odds ‚Ä¢ Sharp Consensus ‚Ä¢ +EV Alerts</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="status">
                    <div class="status-dot off" id="statusDot"></div>
                    <span id="statusText">Disconnected</span>
                </div>
                <button class="btn btn-secondary" onclick="toggleConfig()">‚öôÔ∏è Settings</button>
                <button class="btn btn-primary" onclick="fetchAllData()">‚Üª Refresh</button>
                <button class="btn btn-secondary" onclick="loadDemoData()">Demo</button>
            </div>
        </header>

        <div class="config-panel" id="configPanel">
            <div class="config-title">Configuration</div>
            <div class="config-grid">
                <div class="config-field">
                    <label>SportsGame API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your API key">
                </div>
                <div class="config-field">
                    <label>Min EV Threshold (%)</label>
                    <input type="number" id="minEV" value="2" min="0" max="20" step="0.5">
                </div>
                <div class="config-field">
                    <label>Auto Refresh (seconds)</label>
                    <input type="number" id="refreshInterval" value="30" min="10" max="300">
                </div>
                <div class="config-field">
                    <label>Alert Sounds</label>
                    <select id="alertSound">
                        <option value="on">Enabled</option>
                        <option value="off">Disabled</option>
                    </select>
                </div>
                <div class="config-field books-selector">
                    <label>Select Sharp Books for Consensus Calculation (click to toggle)</label>
                    <div class="books-grid" id="booksGrid"></div>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-box">
                <div class="label">Live Games</div>
                <div class="value cyan" id="statGames">0</div>
            </div>
            <div class="stat-box">
                <div class="label">+EV Opportunities</div>
                <div class="value green" id="statEV">0</div>
            </div>
            <div class="stat-box">
                <div class="label">Best Edge</div>
                <div class="value green" id="statBestEdge">--</div>
            </div>
            <div class="stat-box">
                <div class="label">Last Update</div>
                <div class="value" id="statLastUpdate" style="font-size: 16px;">--</div>
            </div>
        </div>

        <div class="games-list" id="gamesList">
            <div class="loading">
                <div class="spinner"></div>
                <div>Enter your API key and click Refresh, or click Demo to see sample data</div>
            </div>
        </div>
    </div>

    <div class="alerts-container" id="alertsContainer"></div>

    <script>
        const CONFIG = {
            apiKey: '',
            minEV: 2,
            refreshInterval: 30,
            alertSound: true,
            selectedSharpBooks: ['pinnacle', 'circa', 'bookmaker', 'betcris', 'betonline']
        };

        const SPORTSBOOKS = {
            pinnacle: { name: 'Pinnacle', abbr: 'PIN', type: 'sharp' },
            circa: { name: 'Circa', abbr: 'CIR', type: 'sharp' },
            bookmaker: { name: 'Bookmaker', abbr: 'BKM', type: 'sharp' },
            betcris: { name: 'BetCRIS', abbr: 'CRS', type: 'sharp' },
            betonline: { name: 'BetOnline', abbr: 'BOL', type: 'sharp' },
            superbook: { name: 'SuperBook', abbr: 'SUP', type: 'sharp' },
            draftkings: { name: 'DraftKings', abbr: 'DK', type: 'soft' },
            fanduel: { name: 'FanDuel', abbr: 'FD', type: 'soft' },
            betmgm: { name: 'BetMGM', abbr: 'MGM', type: 'soft' },
            caesars: { name: 'Caesars', abbr: 'CZR', type: 'soft' },
            pointsbet: { name: 'PointsBet', abbr: 'PB', type: 'soft' },
            betrivers: { name: 'BetRivers', abbr: 'BR', type: 'soft' },
            bet365: { name: 'Bet365', abbr: '365', type: 'soft' },
            espnbet: { name: 'ESPN Bet', abbr: 'ESPN', type: 'soft' },
            fanatics: { name: 'Fanatics', abbr: 'FAN', type: 'soft' }
        };

        let gamesData = [];
        let alertedEdges = new Set();
        let refreshTimer = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            renderBooksGrid();
            const savedKey = localStorage.getItem('sgApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                CONFIG.apiKey = savedKey;
            }
        });

        function loadConfig() {
            const saved = localStorage.getItem('periodPropsConfig');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(CONFIG, parsed);
                document.getElementById('minEV').value = CONFIG.minEV;
                document.getElementById('refreshInterval').value = CONFIG.refreshInterval;
                document.getElementById('alertSound').value = CONFIG.alertSound ? 'on' : 'off';
            }
        }

        function saveConfig() {
            CONFIG.apiKey = document.getElementById('apiKey').value;
            CONFIG.minEV = parseFloat(document.getElementById('minEV').value);
            CONFIG.refreshInterval = parseInt(document.getElementById('refreshInterval').value);
            CONFIG.alertSound = document.getElementById('alertSound').value === 'on';
            localStorage.setItem('sgApiKey', CONFIG.apiKey);
            localStorage.setItem('periodPropsConfig', JSON.stringify({
                minEV: CONFIG.minEV,
                refreshInterval: CONFIG.refreshInterval,
                alertSound: CONFIG.alertSound,
                selectedSharpBooks: CONFIG.selectedSharpBooks
            }));
        }

        function toggleConfig() {
            document.getElementById('configPanel').classList.toggle('show');
        }

        function renderBooksGrid() {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = Object.entries(SPORTSBOOKS).map(([key, book]) => `
                <div class="book-chip ${book.type} ${CONFIG.selectedSharpBooks.includes(key) ? 'selected' : ''}" 
                     onclick="toggleBook('${key}')">
                    <span>${book.name}</span>
                    <span class="tag">${book.type.toUpperCase()}</span>
                </div>
            `).join('');
        }

        function toggleBook(key) {
            const idx = CONFIG.selectedSharpBooks.indexOf(key);
            if (idx > -1) CONFIG.selectedSharpBooks.splice(idx, 1);
            else CONFIG.selectedSharpBooks.push(key);
            renderBooksGrid();
            saveConfig();
            if (gamesData.length > 0) renderGames();
        }

        async function fetchAllData() {
            saveConfig();
            if (!CONFIG.apiKey) {
                alert('Please enter your SportsGame API key in Settings');
                toggleConfig();
                return;
            }
            updateStatus('loading', 'Fetching...');
            document.getElementById('gamesList').innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading live games...</div></div>';
            
            try {
                const gamesResponse = await fetch(
                    `https://api.sportsgameodds.com/v2/events?leagueID=NHL&status=live`,
                    { headers: { 'x-api-key': CONFIG.apiKey } }
                );
                if (!gamesResponse.ok) throw new Error(`API Error ${gamesResponse.status}`);
                const gamesResult = await gamesResponse.json();
                const liveGames = gamesResult.data || [];
                
                gamesData = [];
                for (const game of liveGames) {
                    try {
                        const oddsResponse = await fetch(
                            `https://api.sportsgameodds.com/v2/odds?eventID=${game.eventID}&oddType=total`,
                            { headers: { 'x-api-key': CONFIG.apiKey } }
                        );
                        const oddsResult = oddsResponse.ok ? await oddsResponse.json() : { data: [] };
                        gamesData.push({ game, odds: oddsResult.data || [] });
                    } catch (e) {
                        gamesData.push({ game, odds: [] });
                    }
                }
                
                renderGames();
                updateStats();
                updateStatus('connected', 'Connected');
                if (refreshTimer) clearInterval(refreshTimer);
                refreshTimer = setInterval(fetchAllData, CONFIG.refreshInterval * 1000);
            } catch (error) {
                updateStatus('error', 'Error');
                document.getElementById('gamesList').innerHTML = `
                    <div class="no-games">
                        <div class="no-games-icon">‚ö†Ô∏è</div>
                        <h3>Error Loading Data</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function updateStatus(state, text) {
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot' + (state === 'error' || state === 'disconnected' ? ' off' : '');
            document.getElementById('statusText').textContent = text;
        }

        function americanToDecimal(american) {
            return american >= 100 ? (american / 100) + 1 : (100 / Math.abs(american)) + 1;
        }

        function americanToImpliedProb(american) {
            return american >= 100 ? 100 / (american + 100) : Math.abs(american) / (Math.abs(american) + 100);
        }

        function calculateNoVigProb(overOdds, underOdds) {
            const overProb = americanToImpliedProb(overOdds);
            const underProb = americanToImpliedProb(underOdds);
            const total = overProb + underProb;
            return { over: overProb / total, under: underProb / total };
        }

        function calculateSharpConsensus(oddsArray, line) {
            const sharpOdds = oddsArray.filter(o => {
                const bookKey = (o.sportsbook || '').toLowerCase();
                return CONFIG.selectedSharpBooks.includes(bookKey) && o.line === line && o.overPrice && o.underPrice;
            });
            if (sharpOdds.length === 0) return null;
            
            let totalOverProb = 0, totalUnderProb = 0;
            sharpOdds.forEach(odds => {
                const noVig = calculateNoVigProb(odds.overPrice, odds.underPrice);
                totalOverProb += noVig.over;
                totalUnderProb += noVig.under;
            });
            
            const avgOverProb = totalOverProb / sharpOdds.length;
            const avgUnderProb = totalUnderProb / sharpOdds.length;
            
            return {
                overProb: avgOverProb,
                underProb: avgUnderProb,
                fairOverOdds: probToFairAmerican(avgOverProb),
                fairUnderOdds: probToFairAmerican(avgUnderProb),
                line: line,
                sharpCount: sharpOdds.length
            };
        }

        function probToFairAmerican(prob) {
            return prob >= 0.5 ? Math.round(-100 * prob / (1 - prob)) : Math.round(100 * (1 - prob) / prob);
        }

        function calculateEV(bookOdds, fairProb) {
            return ((fairProb * americanToDecimal(bookOdds)) - 1) * 100;
        }

        function renderGames() {
            const container = document.getElementById('gamesList');
            if (gamesData.length === 0) {
                container.innerHTML = `<div class="no-games"><div class="no-games-icon">üèí</div><h3>No Live NHL Games</h3><p>Click Demo to see sample data</p></div>`;
                return;
            }
            container.innerHTML = gamesData.map(({ game, odds }) => {
                const hasEdge = checkForEdges(odds);
                return `<div class="game-card ${hasEdge ? 'has-edge' : ''}" id="game-${game.eventID}">
                    ${renderGameHeader(game)}
                    ${renderPeriodTabs(game, odds)}
                    ${renderOddsSection(game, odds)}
                </div>`;
            }).join('');
        }

        function renderGameHeader(game) {
            const away = game.awayTeam || {};
            const home = game.homeTeam || {};
            return `<div class="game-header">
                <div class="matchup">
                    <div class="team">
                        <div class="team-abbr">${away.abbreviation || 'AWY'}</div>
                        <span class="team-name">${away.name || 'Away'}</span>
                        <span class="team-score">${game.awayScore || 0}</span>
                    </div>
                    <span class="vs">@</span>
                    <div class="team">
                        <span class="team-score">${game.homeScore || 0}</span>
                        <span class="team-name">${home.name || 'Home'}</span>
                        <div class="team-abbr">${home.abbreviation || 'HME'}</div>
                    </div>
                </div>
                <div class="game-status">
                    <div class="period-badge"><span class="live-dot"></span>P${game.period || 1}</div>
                    <div class="time-left">${game.clock || '20:00'}</div>
                </div>
            </div>`;
        }

        function renderPeriodTabs(game, odds) {
            const currentPeriod = game.period || 1;
            return `<div class="period-tabs">
                ${['1P', '2P', '3P'].map((p, idx) => {
                    const periodNum = idx + 1;
                    const periodOdds = odds.filter(o => o.period === p);
                    const hasEdge = checkForEdges(periodOdds);
                    const isActive = periodNum === currentPeriod;
                    return `<button class="period-tab ${isActive ? 'active' : ''} ${hasEdge ? 'has-edge' : ''}"
                        data-period="${p}" onclick="switchPeriodView(this, '${game.eventID}')"
                        ${periodNum > currentPeriod ? 'style="opacity:0.5"' : ''}>
                        Period ${periodNum} ${isActive ? '(Live)' : ''}
                    </button>`;
                }).join('')}
            </div>`;
        }

        function switchPeriodView(btn, gameId) {
            btn.parentElement.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            const gameData = gamesData.find(g => g.game.eventID === gameId);
            if (gameData) {
                const section = document.querySelector(`#game-${gameId} .odds-section`);
                if (section) section.outerHTML = renderOddsSection(gameData.game, gameData.odds, btn.dataset.period);
            }
        }

        function renderOddsSection(game, odds, selectedPeriod = null) {
            const currentPeriod = selectedPeriod || `${game.period || 1}P`;
            const periodOdds = odds.filter(o => o.period === currentPeriod);
            const lineGroups = {};
            periodOdds.forEach(o => {
                const line = o.line || 1.5;
                if (!lineGroups[line]) lineGroups[line] = [];
                lineGroups[line].push(o);
            });
            const primaryLine = Object.keys(lineGroups).sort((a, b) => lineGroups[b].length - lineGroups[a].length)[0] || 1.5;
            const consensus = calculateSharpConsensus(periodOdds, parseFloat(primaryLine));
            
            return `<div class="odds-section">
                <div class="odds-header">
                    <div class="odds-title">üìä Period ${currentPeriod.replace('P', '')} Total</div>
                    ${consensus ? `<div class="consensus-box">
                        <div class="consensus-item"><div class="lbl">Line</div><div class="val">${consensus.line}</div></div>
                        <div class="consensus-item"><div class="lbl">Fair Over</div><div class="val">${formatOdds(consensus.fairOverOdds)}</div></div>
                        <div class="consensus-item"><div class="lbl">Fair Under</div><div class="val">${formatOdds(consensus.fairUnderOdds)}</div></div>
                        <div class="consensus-item"><div class="lbl">Sharp Books</div><div class="val">${consensus.sharpCount}</div></div>
                    </div>` : ''}
                </div>
                <div class="odds-table-wrap">${renderOddsTable(periodOdds, consensus, game, primaryLine)}</div>
            </div>`;
        }

        function renderOddsTable(odds, consensus, game, primaryLine) {
            const lineOdds = odds.filter(o => (o.line || 1.5) == primaryLine);
            if (lineOdds.length === 0) return '<div class="loading">No period total odds available</div>';
            
            let bestOver = -Infinity, bestUnder = -Infinity, worstOver = Infinity, worstUnder = Infinity;
            lineOdds.forEach(o => {
                if (o.overPrice) { bestOver = Math.max(bestOver, o.overPrice); worstOver = Math.min(worstOver, o.overPrice); }
                if (o.underPrice) { bestUnder = Math.max(bestUnder, o.underPrice); worstUnder = Math.min(worstUnder, o.underPrice); }
            });
            
            const sortedOdds = [...lineOdds].sort((a, b) => {
                const aSharp = SPORTSBOOKS[(a.sportsbook || '').toLowerCase()]?.type === 'sharp' ? 0 : 1;
                const bSharp = SPORTSBOOKS[(b.sportsbook || '').toLowerCase()]?.type === 'sharp' ? 0 : 1;
                return aSharp - bSharp || (a.sportsbook || '').localeCompare(b.sportsbook || '');
            });
            
            return `<table class="odds-table">
                <thead><tr>
                    <th>Sportsbook</th><th>Line</th><th style="text-align:center">Over</th>
                    <th style="text-align:center">Under</th><th style="text-align:center">Over EV</th>
                    <th style="text-align:center">Under EV</th><th>Signal</th>
                </tr></thead>
                <tbody>
                    ${consensus ? `<tr class="consensus-row">
                        <td><div class="consensus-label"><span>‚ö°</span>Sharp Consensus (${consensus.sharpCount})</div></td>
                        <td>${consensus.line}</td>
                        <td class="odds-cell"><span class="odds-val">${formatOdds(consensus.fairOverOdds)}</span></td>
                        <td class="odds-cell"><span class="odds-val">${formatOdds(consensus.fairUnderOdds)}</span></td>
                        <td class="ev-cell">--</td><td class="ev-cell">--</td>
                        <td style="color:var(--accent-ice)">Fair Line</td>
                    </tr>` : ''}
                    ${sortedOdds.map(o => renderOddsRow(o, consensus, bestOver, bestUnder, worstOver, worstUnder, game, lineOdds.length)).join('')}
                </tbody>
            </table>`;
        }

        function renderOddsRow(odds, consensus, bestOver, bestUnder, worstOver, worstUnder, game, totalBooks) {
            const bookKey = (odds.sportsbook || '').toLowerCase();
            const book = SPORTSBOOKS[bookKey] || { name: odds.sportsbook || bookKey, abbr: bookKey.substring(0, 3).toUpperCase(), type: 'soft' };
            const overPrice = odds.overPrice, underPrice = odds.underPrice, line = odds.line || 1.5;
            
            let overEV = null, underEV = null;
            if (consensus) {
                if (overPrice) overEV = calculateEV(overPrice, consensus.overProb);
                if (underPrice) underEV = calculateEV(underPrice, consensus.underProb);
            }
            
            const hasOverEdge = overEV && overEV >= CONFIG.minEV;
            const hasUnderEdge = underEV && underEV >= CONFIG.minEV;
            
            if (hasOverEdge || hasUnderEdge) {
                const edgeKey = `${game.eventID}-${bookKey}-${line}-${overPrice}-${underPrice}`;
                if (!alertedEdges.has(edgeKey)) {
                    alertedEdges.add(edgeKey);
                    triggerAlert(game, book, odds, overEV, underEV, hasOverEdge, hasUnderEdge);
                }
            }
            
            return `<tr>
                <td><div class="book-cell">
                    <div class="book-icon">${book.abbr}</div>
                    <span>${book.name}</span>
                    <span class="book-type ${book.type}">${book.type.toUpperCase()}</span>
                </div></td>
                <td>${line}</td>
                <td class="odds-cell">${overPrice ? `<span class="odds-val ${overPrice === bestOver ? 'best' : ''} ${overPrice === worstOver && totalBooks > 2 ? 'worst' : ''}">${formatOdds(overPrice)}</span>` : '--'}</td>
                <td class="odds-cell">${underPrice ? `<span class="odds-val ${underPrice === bestUnder ? 'best' : ''} ${underPrice === worstUnder && totalBooks > 2 ? 'worst' : ''}">${formatOdds(underPrice)}</span>` : '--'}</td>
                <td class="ev-cell">${overEV !== null ? `<span class="ev-val ${overEV >= CONFIG.minEV ? 'pos' : 'neg'}">${overEV > 0 ? '+' : ''}${overEV.toFixed(1)}%</span>` : '--'}</td>
                <td class="ev-cell">${underEV !== null ? `<span class="ev-val ${underEV >= CONFIG.minEV ? 'pos' : 'neg'}">${underEV > 0 ? '+' : ''}${underEV.toFixed(1)}%</span>` : '--'}</td>
                <td>${hasOverEdge ? `<span class="edge-tag">üî• OVER +${overEV.toFixed(1)}%</span>` : ''}${hasUnderEdge ? `<span class="edge-tag">üî• UNDER +${underEV.toFixed(1)}%</span>` : ''}${!hasOverEdge && !hasUnderEdge ? '‚Äî' : ''}</td>
            </tr>`;
        }

        function formatOdds(american) {
            return american == null ? '--' : (american > 0 ? `+${american}` : `${american}`);
        }

        function checkForEdges(odds) {
            if (!odds?.length) return false;
            const lines = [...new Set(odds.map(o => o.line || 1.5))];
            for (const line of lines) {
                const lineOdds = odds.filter(o => (o.line || 1.5) === line);
                const consensus = calculateSharpConsensus(lineOdds, line);
                if (!consensus) continue;
                for (const o of lineOdds) {
                    if (o.overPrice && calculateEV(o.overPrice, consensus.overProb) >= CONFIG.minEV) return true;
                    if (o.underPrice && calculateEV(o.underPrice, consensus.underProb) >= CONFIG.minEV) return true;
                }
            }
            return false;
        }

        function triggerAlert(game, book, odds, overEV, underEV, hasOverEdge, hasUnderEdge) {
            const container = document.getElementById('alertsContainer');
            const time = new Date().toLocaleTimeString();
            const away = game.awayTeam?.abbreviation || 'AWY';
            const home = game.homeTeam?.abbreviation || 'HME';
            const line = odds.line || 1.5;
            const side = hasOverEdge && (!hasUnderEdge || overEV > underEV) ? `Over ${line}` : `Under ${line}`;
            const ev = hasOverEdge && (!hasUnderEdge || overEV > underEV) ? overEV : underEV;
            const price = hasOverEdge && (!hasUnderEdge || overEV > underEV) ? odds.overPrice : odds.underPrice;
            
            const alertId = `alert-${Date.now()}`;
            container.insertAdjacentHTML('beforeend', `
                <div class="alert" id="${alertId}">
                    <div class="alert-header">
                        <span class="alert-title">üî• +EV Found!</span>
                        <div><span class="alert-time">${time}</span><button class="alert-close" onclick="dismissAlert('${alertId}')">√ó</button></div>
                    </div>
                    <div class="alert-content">
                        <strong>${away} @ ${home}</strong> - P${game.period || 1}<br>
                        ${book.name}: <strong>${side}</strong> @ ${formatOdds(price)}
                        <div class="alert-ev">+${ev.toFixed(1)}% EV</div>
                    </div>
                </div>
            `);
            if (CONFIG.alertSound) playAlertSound();
            setTimeout(() => dismissAlert(alertId), 60000);
        }

        function dismissAlert(id) {
            const alert = document.getElementById(id);
            if (alert) { alert.style.opacity = '0'; setTimeout(() => alert.remove(), 300); }
        }

        function playAlertSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = 880; osc.type = 'sine';
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.2);
            } catch (e) {}
        }

        function updateStats() {
            document.getElementById('statGames').textContent = gamesData.length;
            document.getElementById('statLastUpdate').textContent = new Date().toLocaleTimeString();
            let evCount = 0, bestEdge = 0;
            gamesData.forEach(({ odds }) => {
                if (!odds?.length) return;
                const lines = [...new Set(odds.map(o => o.line || 1.5))];
                for (const line of lines) {
                    const lineOdds = odds.filter(o => (o.line || 1.5) === line);
                    const consensus = calculateSharpConsensus(lineOdds, line);
                    if (!consensus) continue;
                    lineOdds.forEach(o => {
                        if (o.overPrice) { const ev = calculateEV(o.overPrice, consensus.overProb); if (ev >= CONFIG.minEV) { evCount++; bestEdge = Math.max(bestEdge, ev); } }
                        if (o.underPrice) { const ev = calculateEV(o.underPrice, consensus.underProb); if (ev >= CONFIG.minEV) { evCount++; bestEdge = Math.max(bestEdge, ev); } }
                    });
                }
            });
            document.getElementById('statEV').textContent = evCount;
            document.getElementById('statBestEdge').textContent = bestEdge > 0 ? `+${bestEdge.toFixed(1)}%` : '--';
        }

        function loadDemoData() {
            alertedEdges.clear();
            gamesData = [
                {
                    game: { eventID: 'demo1', awayTeam: { name: 'Rangers', abbreviation: 'NYR' }, homeTeam: { name: 'Bruins', abbreviation: 'BOS' }, awayScore: 2, homeScore: 1, period: 2, clock: '14:32' },
                    odds: [
                        { sportsbook: 'Pinnacle', period: '2P', line: 1.5, overPrice: -125, underPrice: 105 },
                        { sportsbook: 'Circa', period: '2P', line: 1.5, overPrice: -120, underPrice: 100 },
                        { sportsbook: 'Bookmaker', period: '2P', line: 1.5, overPrice: -122, underPrice: 102 },
                        { sportsbook: 'BetCRIS', period: '2P', line: 1.5, overPrice: -118, underPrice: -102 },
                        { sportsbook: 'DraftKings', period: '2P', line: 1.5, overPrice: -130, underPrice: 110 },
                        { sportsbook: 'FanDuel', period: '2P', line: 1.5, overPrice: -110, underPrice: -110 },
                        { sportsbook: 'BetMGM', period: '2P', line: 1.5, overPrice: -140, underPrice: 120 },
                        { sportsbook: 'Caesars', period: '2P', line: 1.5, overPrice: -128, underPrice: 108 },
                    ]
                },
                {
                    game: { eventID: 'demo2', awayTeam: { name: 'Lightning', abbreviation: 'TBL' }, homeTeam: { name: 'Panthers', abbreviation: 'FLA' }, awayScore: 0, homeScore: 1, period: 1, clock: '08:15' },
                    odds: [
                        { sportsbook: 'Pinnacle', period: '1P', line: 1.5, overPrice: -108, underPrice: -112 },
                        { sportsbook: 'Circa', period: '1P', line: 1.5, overPrice: -105, underPrice: -115 },
                        { sportsbook: 'Bookmaker', period: '1P', line: 1.5, overPrice: -110, underPrice: -110 },
                        { sportsbook: 'BetOnline', period: '1P', line: 1.5, overPrice: -108, underPrice: -112 },
                        { sportsbook: 'DraftKings', period: '1P', line: 1.5, overPrice: -120, underPrice: 100 },
                        { sportsbook: 'FanDuel', period: '1P', line: 1.5, overPrice: -105, underPrice: -115 },
                        { sportsbook: 'BetMGM', period: '1P', line: 1.5, overPrice: 105, underPrice: -125 },
                    ]
                },
                {
                    game: { eventID: 'demo3', awayTeam: { name: 'Oilers', abbreviation: 'EDM' }, homeTeam: { name: 'Kings', abbreviation: 'LAK' }, awayScore: 3, homeScore: 2, period: 3, clock: '05:44' },
                    odds: [
                        { sportsbook: 'Pinnacle', period: '3P', line: 1.5, overPrice: -115, underPrice: -105 },
                        { sportsbook: 'Circa', period: '3P', line: 1.5, overPrice: -112, underPrice: -108 },
                        { sportsbook: 'Bookmaker', period: '3P', line: 1.5, overPrice: -110, underPrice: -110 },
                        { sportsbook: 'DraftKings', period: '3P', line: 1.5, overPrice: -125, underPrice: 105 },
                        { sportsbook: 'BetMGM', period: '3P', line: 1.5, overPrice: -135, underPrice: 115 },
                    ]
                }
            ];
            renderGames();
            updateStats();
            updateStatus('connected', 'Demo Mode');
        }
    </script>
</body>
</html>
